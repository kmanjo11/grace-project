(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[106],{356:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>b});var a=s(7765),o=s(5977),l=s(1742),r=s(6395),n=s(8939),i=s(1701);let c=function(e,t,s){var a,l;let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",{state:n,dispatch:c}=(0,i.A)(),d=()=>{var e;if((null==(e=n.chatState)?void 0:e.sessions)&&Object.keys(n.chatState.sessions).length>0)return Object.values(n.chatState.sessions||{}).map(e=>({id:e.id||e.session_id||"",session_id:e.session_id||e.id||"",name:e.name||e.topic||"Chat ".concat((e.session_id||e.id||"").slice(0,6)),topic:e.topic||e.name||"",lastActivity:e.updated_at||new Date().toISOString(),messages:Array.isArray(e.messages)?e.messages.map(e=>({sender:"user"===e.role?"user":"grace",text:e.content||"",timestamp:e.timestamp||new Date().toISOString(),user:"user"===e.role?e.content:void 0,bot:"assistant"===e.role?e.content:void 0})):[],scrollPosition:e.scrollPosition,unread_count:e.unread_count||0}));let t=localStorage.getItem("activeSessionId");if(t)try{let e=m(t);if(e.length>0)return[{id:t,session_id:t,name:"Chat ".concat(t.slice(0,6)),topic:"Chat ".concat(t.slice(0,6)),lastActivity:localStorage.getItem("lastSynced_".concat(t))||new Date().toISOString(),messages:e}]}catch(e){console.error("Error loading sessions from cache:",e)}return[]},m=e=>{if(!e)return[];try{var t,s,a;let o=null==(a=n.chatState)||null==(s=a.sessions)||null==(t=s[e])?void 0:t.messages;if(Array.isArray(o)&&o.length>0)return console.log("Restoring ".concat(o.length," messages from global state for session ").concat(e)),o.map(e=>({sender:"user"===e.role?"user":"grace",text:e.content||"",timestamp:e.timestamp||new Date().toISOString(),user:"user"===e.role?e.content:void 0,bot:"assistant"===e.role?e.content:void 0}));let l=localStorage.getItem("messages_".concat(e));if(l){let t=JSON.parse(l);if(Array.isArray(t)&&t.length>0)return console.log("Restoring ".concat(t.length," messages from localStorage for session ").concat(e)),t}}catch(e){console.error("Error loading messages from cache:",e)}return[]};(0,o.useEffect)(()=>{let e=d();e.length>0&&0===t.length&&console.log("Chat sessions available in persistent state",e)},[null==(a=n.chatState)?void 0:a.sessions,t]),(0,o.useEffect)(()=>{if(e&&t.length>0){var s;let a=t.reduce((e,t)=>{let s=t.session_id||t.id;return s&&(e[s]={id:t.id,session_id:t.session_id||t.id,topic:t.topic||t.name,name:t.name,created_at:t.created_at||t.lastActivity,updated_at:t.lastActivity||new Date().toISOString(),preview_message:t.messages&&t.messages.length>0?t.messages[t.messages.length-1].text||t.messages[t.messages.length-1].user||t.messages[t.messages.length-1].bot:"",messages:t.messages.map(e=>({id:e.timestamp||new Date().toISOString(),content:e.text||e.user||e.bot||"",role:"user"===e.sender?"user":"assistant",timestamp:e.timestamp||new Date().toISOString()})),scrollPosition:t.scrollPosition,unread_count:t.unread_count||0}),e},{});c({type:"SET_CHAT_STATE",payload:{activeSessions:t.map(e=>e.session_id||e.id),currentSessionId:e,sessions:a,draftMessages:{...(null==(s=n.chatState)?void 0:s.draftMessages)||{},[e]:r}}});let o=t.find(t=>t.id===e||t.session_id===e);o&&o.messages&&u(e,o.messages)}},[t,e,s,r,c]),(0,o.useEffect)(()=>{var t;if(e&&s.length>0&&(null==(t=n.chatState)?void 0:t.sessions)){let t=n.chatState.sessions[e];t&&!g(t.messages||[],s)&&c({type:"SET_CHAT_STATE",payload:{sessions:{...n.chatState.sessions,[e]:{...t,messages:s,updated_at:new Date().toISOString()}}}})}},[s,e,null==(l=n.chatState)?void 0:l.sessions,c]);let g=(e,t)=>e.length===t.length&&e.length===t.length,u=(e,t)=>{if(e&&t)try{var s,a,o,l;console.log("Persisting ".concat(t.length," messages for session ").concat(e));let r=t.slice(-100);localStorage.setItem("messages_".concat(e),JSON.stringify(r)),localStorage.setItem("lastSynced_".concat(e),new Date().toISOString()),localStorage.setItem("activeSessionId",e);let i=r.map(e=>({id:Math.random().toString(36).substring(2,15),content:e.text||e.user||e.bot||"",role:"user"===e.sender||e.user?"user":"assistant",timestamp:e.timestamp||new Date().toISOString()}));c({type:"SET_CHAT_CONTEXT",payload:{currentConversationId:e,lastMessageTimestamp:new Date().getTime()}}),c({type:"SET_CHAT_STATE",payload:{currentSessionId:e,sessions:{...(null==(s=n.chatState)?void 0:s.sessions)||{},[e]:{id:e,session_id:e,messages:i,updated_at:new Date().toISOString(),...(null==(o=n.chatState)||null==(a=o.sessions)?void 0:a[e])||{},preview_message:(null==(l=r[r.length-1])?void 0:l.text)||""}}}})}catch(e){console.error("Failed to store messages:",e)}};return{initializeFromPersistedState:(e,s)=>{let a=d();if(a.length>0&&0===t.length){var o,l;e(a);let t=localStorage.getItem("activeSessionId");return s(t?a.some(e=>e.session_id===t||e.id===t)?t:(null==(l=n.chatState)?void 0:l.currentSessionId)?n.chatState.currentSessionId:a[0].session_id||a[0].id:(null==(o=n.chatState)?void 0:o.currentSessionId)?n.chatState.currentSessionId:a[0].session_id||a[0].id),!0}return!1},getStoredSessions:d,loadMessagesFromCache:m,persistMessages:u,syncScrollPosition:t=>{var s,a,o;e&&(localStorage.setItem("scrollPosition_".concat(e),t.toString()),c({type:"SET_CHAT_STATE",payload:{sessions:{...(null==(s=n.chatState)?void 0:s.sessions)||{},[e]:{...(null==(o=n.chatState)||null==(a=o.sessions)?void 0:a[e])||{},scrollPosition:t}}}}))},getSavedScrollPosition:()=>{var t,s;if(!e)return null;let a=localStorage.getItem("scrollPosition_".concat(e));return a?parseInt(a,10):(null==(s=n.chatState)||null==(t=s.sessions)?void 0:t[e])?n.chatState.sessions[e].scrollPosition:null},getSavedDraftMessage:()=>{var t;if(!e)return"";let s=localStorage.getItem("draft_".concat(e));return s||(null==(t=n.chatState)?void 0:t.draftMessages)&&e in n.chatState.draftMessages&&n.chatState.draftMessages[e]||""},updateDraftMessage:t=>{var s;e&&(localStorage.setItem("draft_".concat(e),t),c({type:"SET_CHAT_STATE",payload:{draftMessages:{...(null==(s=n.chatState)?void 0:s.draftMessages)||{},[e]:t}}}))}}};var d=s(901),m=s(116),g=s(7351),u=s(9539),h=s(7987),f=s(4941),x=s(2755),p=s(8151),v=s(9317);let S=e=>{var t;let{maxItems:s=5}=e,{state:l,dispatch:r}=(0,i.A)(),[n,c]=(0,o.useState)([]),[S,b]=(0,o.useState)(!1),[y,w]=(0,o.useState)(null),[N,_]=(0,o.useState)(!1),[j,I]=(0,o.useState)(""),A=(null==(t=l.xfeed)?void 0:t.followedAccounts)||[];(0,o.useEffect)(()=>{A.length>0&&T()},[A]);let T=async()=>{if(0!==A.length){b(!0),w(null);try{let e=A.map(e=>{let t="from:".concat(e.replace("@",""));return console.log("Fetching tweets for ".concat(e," with query: ").concat(t)),v.A.get("/api/social/tweets",{params:{query:t,search_type:"tweets",count:Math.ceil(s/A.length),include_media:!0}})}),t=await Promise.all(e),a=[];t.forEach((e,t)=>{let s=e.data.data||{};if(s.results&&Array.isArray(s.results)){let e=s.results.map(e=>{var s,a,o;return{id:e.id,text:e.text,created_at:e.created_at,username:(null==(s=e.user)?void 0:s.username)||A[t],name:(null==(a=e.user)?void 0:a.name)||A[t],profile_image_url:null==(o=e.user)?void 0:o.profile_image_url,media:e.media,heat_score:C(e),likes_count:e.likes_count||0,retweets_count:e.retweets_count||0}});a=[...a,...e]}}),a.sort((e,t)=>new Date(t.created_at).getTime()-new Date(e.created_at).getTime()),c(a.slice(0,s))}catch(e){console.error("Error fetching tweets:",e),w("Failed to load tweets. Please try again later.")}finally{b(!1)}}},C=e=>{let t=e.likes_count||0,s=e.retweets_count||0,a=new Date(e.created_at),o=(new Date().getTime()-a.getTime())/36e5;return Math.min(100,Math.round((+t+2*s+100*(o<24?(24-o)/24:0)*3)/10))};return(0,a.jsxs)("div",{className:"p-4 h-full flex flex-col overflow-hidden bg-white rounded-md shadow",children:[(0,a.jsxs)("div",{className:"flex items-center mb-4",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold flex-grow",children:"X Feed"}),(0,a.jsxs)("div",{className:"flex space-x-2",children:[(0,a.jsx)("button",{className:"p-1 rounded-full hover:bg-gray-100 transition-colors ".concat(S?"opacity-50 cursor-not-allowed":""),onClick:T,disabled:S,"aria-label":"Refresh feed",children:(0,a.jsx)(d.A,{className:"h-5 w-5"})}),(0,a.jsx)("button",{className:"p-1 rounded-full hover:bg-gray-100 transition-colors",onClick:()=>_(!0),"aria-label":"Feed settings",children:(0,a.jsx)(m.A,{className:"h-5 w-5"})})]})]}),(0,a.jsx)("div",{className:"overflow-auto flex-1",children:0===A.length?(0,a.jsxs)("div",{className:"p-4 text-center",children:[(0,a.jsx)("p",{className:"text-base text-gray-600",children:"No accounts followed"}),(0,a.jsxs)("button",{className:"mt-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-sm flex items-center mx-auto",onClick:()=>_(!0),children:[(0,a.jsx)(g.A,{className:"h-4 w-4 mr-1"}),"Add Accounts"]})]}):S?(0,a.jsx)("div",{className:"flex justify-center p-6",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"})}):y?(0,a.jsx)("div",{className:"p-4 text-center",children:(0,a.jsx)("p",{className:"text-base text-red-600",children:y})}):0===n.length?(0,a.jsx)("div",{className:"p-4 text-center",children:(0,a.jsx)("p",{className:"text-base text-gray-600",children:"No tweets found"})}):n.map(e=>(0,a.jsx)("div",{className:"mb-4 p-3 bg-white rounded-lg border border-gray-200 hover:shadow-md transition-shadow",children:(0,a.jsxs)("div",{className:"flex",children:[(0,a.jsx)("div",{className:"mr-3",children:e.profile_image_url?(0,a.jsx)("img",{src:e.profile_image_url,alt:e.name,className:"w-10 h-10 rounded-full"}):(0,a.jsx)("div",{className:"w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-semibold",children:e.username.charAt(0).toUpperCase()})}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("span",{className:"font-semibold text-sm",children:e.name}),(0,a.jsxs)("span",{className:"ml-1 text-xs text-gray-500",children:["@",e.username]}),(0,a.jsx)("span",{className:"ml-auto text-xs text-gray-500",children:(e=>{try{let t=new Date(e),s=new Date().getTime()-t.getTime(),a=Math.floor(s/864e5);if(0===a){let e=Math.floor(s/36e5);if(0===e){let e=Math.floor(s/6e4);return"".concat(e," min").concat(1!==e?"s":""," ago")}return"".concat(e," hour").concat(1!==e?"s":""," ago")}if(1===a)return"Yesterday";if(a<7)return"".concat(a," days ago");else return t.toLocaleDateString()}catch(t){return e}})(e.created_at)})]}),(0,a.jsx)("div",{className:"mt-1 text-sm",children:e.text}),e.media&&e.media.length>0&&"photo"===e.media[0].type&&(0,a.jsx)("div",{className:"mt-2",children:(0,a.jsx)("img",{src:e.media[0].url,alt:"Tweet media",className:"max-h-[150px] object-contain rounded"})}),(0,a.jsxs)("div",{className:"flex mt-2 text-xs text-gray-500 space-x-4",children:[(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)(u.A,{className:"h-3 w-3 mr-1"}),e.likes_count]}),(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)(h.A,{className:"h-3 w-3 mr-1"}),e.retweets_count]}),void 0!==e.heat_score&&(0,a.jsxs)("div",{className:"ml-auto px-1.5 py-0.5 rounded text-white text-xs ".concat(e.heat_score>80?"bg-red-500":e.heat_score>50?"bg-yellow-500":"bg-blue-500"),children:[e.heat_score,"\xb0"]})]})]})]})},e.id))}),(0,a.jsx)(x.e,{appear:!0,show:N,as:o.Fragment,children:(0,a.jsxs)(p.lG,{as:"div",className:"relative z-10",onClose:()=>_(!1),children:[(0,a.jsx)(x.e.Child,{as:o.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-25"})}),(0,a.jsx)("div",{className:"fixed inset-0 overflow-y-auto",children:(0,a.jsx)("div",{className:"flex min-h-full items-center justify-center p-4 text-center",children:(0,a.jsx)(x.e.Child,{as:o.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",children:(0,a.jsxs)(p.lG.Panel,{className:"w-full max-w-md transform overflow-hidden rounded-2xl bg-white p-6 text-left align-middle shadow-xl transition-all",children:[(0,a.jsx)(p.lG.Title,{as:"h3",className:"text-lg font-medium leading-6 text-gray-900",children:"X Feed Settings"}),(0,a.jsxs)("div",{className:"mt-4",children:[(0,a.jsx)("h4",{className:"text-sm font-medium text-gray-700",children:"Add X accounts to follow"}),(0,a.jsxs)("div",{className:"mt-2 flex",children:[(0,a.jsx)("input",{type:"text",className:"flex-grow rounded-md border border-gray-300 px-3 py-1.5 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500",placeholder:"@username",value:j,onChange:e=>I(e.target.value)}),(0,a.jsx)("button",{type:"button",className:"ml-2 rounded-md bg-blue-600 px-3.5 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 ".concat(j.trim()?"":"opacity-50 cursor-not-allowed"),onClick:()=>{if(!j.trim())return;let e=j.trim();if(e.startsWith("@")&&(e=e.substring(1)),e=e.replace(/[^a-zA-Z0-9_]/g,"")){if(A.includes(e))return void I("");r({type:"UPDATE_XFEED",payload:{followedAccounts:[...A,e]}}),I(""),0===A.length&&T()}},disabled:!j.trim(),children:"Add"})]})]}),(0,a.jsx)("div",{className:"mt-4",children:(0,a.jsxs)("div",{className:"border-t border-gray-200 pt-4",children:[(0,a.jsx)("h4",{className:"text-sm font-medium text-gray-700",children:"Followed Accounts"}),0===A.length?(0,a.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"No accounts added yet"}):(0,a.jsx)("ul",{className:"mt-2 space-y-2",children:A.map(e=>(0,a.jsxs)("li",{className:"flex items-center justify-between",children:[(0,a.jsxs)("span",{className:"text-sm",children:["@",e]}),(0,a.jsx)("button",{type:"button",onClick:()=>{r({type:"UPDATE_XFEED",payload:{followedAccounts:A.filter(t=>t!==e)}})},className:"rounded-full p-1 text-gray-400 hover:text-red-600 hover:bg-red-50",children:(0,a.jsx)(f.A,{className:"h-4 w-4"})})]},e))})]})}),(0,a.jsx)("div",{className:"mt-6 flex justify-end",children:(0,a.jsx)("button",{type:"button",className:"rounded-md bg-gray-100 px-3.5 py-1.5 text-sm font-semibold text-gray-900 shadow-sm hover:bg-gray-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-600",onClick:()=>_(!1),children:"Close"})})]})})})})]})})]})};function b(){let{user:e,isAuthenticated:t}=(0,r.A)(),s=(0,n.c4)(),[i,d]=(0,o.useState)([]),[m,g]=(0,o.useState)(null),[u,h]=(0,o.useState)([]),[f,x]=(0,o.useState)(""),[p,v]=(0,o.useState)(!1),[b,y]=(0,o.useState)(""),[w,N]=(0,o.useState)(!1),_=(0,o.useRef)(null),{initializeFromPersistedState:j,getSavedDraftMessage:I,updateDraftMessage:A,syncScrollPosition:T,getSavedScrollPosition:C}=c(m,i,u,f),E=e=>{if(!e)return"New Conversation";try{let t=e.split(".")[0].trim();return(t.length>30?t.substring(0,30)+"...":t)||"New Conversation"}catch(e){return console.error("Error generating topic:",e),"New Conversation"}},D=(e,t)=>{if(e&&t)try{let s=t.slice(-50);localStorage.setItem("messages_".concat(e),JSON.stringify(s)),localStorage.setItem("lastSynced_".concat(e),new Date().toISOString()),localStorage.setItem("activeSessionId",e)}catch(e){console.error("Failed to store messages in localStorage:",e)}},k=e=>{if(!e)return[];try{let t=localStorage.getItem("messages_".concat(e));if(t){let s=JSON.parse(t);if(Array.isArray(s)&&s.length>0)return console.log("Loaded cached messages for session:",e),s}}catch(e){console.error("Failed to load messages from cache:",e)}return[]},F=(0,o.useRef)(!0);(0,o.useEffect)(()=>{!w&&t&&j(d,g)&&(N(!0),console.log("Chat sessions restored from persisted state"))},[w,t,j]),(0,o.useEffect)(()=>{if(m){let e=I();e&&e!==f&&x(e)}},[m,I]),(0,o.useEffect)(()=>{m&&f&&A(f)},[m,f,A]),(0,o.useEffect)(()=>{if(_.current){let e=C();null!==e?setTimeout(()=>{var t;let s=null==(t=_.current)?void 0:t.parentElement;s&&"number"==typeof e&&!isNaN(e)&&(s.scrollTop=e)},100):_.current.scrollIntoView({behavior:"smooth"})}},[u,m,C]);let O=(0,o.useCallback)(e=>{m&&T(e.currentTarget.scrollTop)},[m,T]);(0,o.useEffect)(()=>()=>{F.current=!1},[]),(0,o.useEffect)(()=>{(async()=>{if(!t||!s){d([]),g(null),h([]),N(!1);try{JSON.parse(localStorage.getItem("activeSessionIds")||"[]").forEach(e=>{localStorage.removeItem("messages_".concat(e))}),localStorage.removeItem("activeSessionIds"),localStorage.removeItem("activeSessionId")}catch(e){console.error("Error cleaning up localStorage on logout:",e)}return}try{let{data:e,success:t}=await l.FH.get(l.Sn.CHAT.SESSIONS);if(t&&e&&Array.isArray(e)){console.log("Loaded sessions:",e);let t=e.map(e=>{let t=e.topic||e.name;if(!t||"New Chat"===t||"New Conversation"===t)if(e.preview_message)t=E(e.preview_message);else if(e.messages&&Array.isArray(e.messages)&&e.messages.length>0){let s=e.messages[0],a=s.text||s.user||s.message;t=E(a)}else t="Conversation ".concat(new Date(e.lastActivity||e.created||new Date).toLocaleDateString());return{id:e.session_id||e.id,name:t,lastActivity:e.lastActivity||e.last_activity||new Date().toISOString(),messages:[],session_id:e.session_id||e.id,topic:t}}).sort((e,t)=>new Date(t.lastActivity).getTime()-new Date(e.lastActivity).getTime());d(t);let s=localStorage.getItem("activeSessionId"),a=t.some(e=>e.session_id===s||e.id===s);if(s&&a){g(s);try{let e=localStorage.getItem("messages_".concat(s));if(e)try{let t=JSON.parse(e);console.log("Restored ".concat(t.length," messages for session ").concat(s," from localStorage")),h(t),P(!0),localStorage.setItem("activeSessionId",s)}catch(e){console.error("Failed to parse saved messages:",e)}}catch(e){console.error("Failed to access localStorage:",e)}H(s)}else t.length>0?(g(t[0].session_id||t[0].id),H(t[0].session_id||t[0].id)):await z()}else await z()}catch(e){console.error("Failed to load sessions:",e),y("Failed to load chat sessions"),await z()}})()},[t,s]);let[M,P]=(0,o.useState)(!1),H=(0,o.useCallback)(async e=>{if(!e||!t)return;let s=k(e),a=s.length>0;a&&(console.log("Using cached messages while backend loads for session:",e),JSON.stringify(s)!==JSON.stringify(u)&&(h(s),P(!0),localStorage.setItem("activeSessionId",e)));try{if(y(""),!(0,n.c4)())return void console.error("No auth token available");let{data:t,success:o}=await l.FH.get(l.Sn.CHAT.HISTORY(e));if(o&&t&&Array.isArray(t)){let o=t.map(e=>e.user?{sender:"user",text:e.user,timestamp:e.timestamp}:e.bot?{sender:"grace",text:e.bot,timestamp:e.timestamp}:e);if(o.length>0)if(a)if(o.length>s.length)console.log("Backend has more messages than cache, updating"),h(o),D(e,o);else{let t=o.length>0?new Date(o[o.length-1].timestamp).getTime():0,a=s.filter(e=>new Date(e.timestamp||Date.now()).getTime()>t);if(a.length>0){console.log("Merging backend messages with local messages");let t=[...o,...a];h(t),D(e,t)}else JSON.stringify(o)!==JSON.stringify(s)&&(h(o),D(e,o))}else console.log("Setting messages from backend, no cache available"),h(o),D(e,o);else a||h([])}}catch(t){console.error("Failed to load messages for session ".concat(e,":"),t),a||h([])}},[t]);(0,o.useEffect)(()=>{m&&t&&w&&(console.log("Session ID changed, loading messages for:",m),localStorage.setItem("activeSessionId",m),H(m))},[m,H,t,w]),(0,o.useEffect)(()=>{if(!t||!w)return;console.log("Attempting to restore previous session");let e=[...i].sort((e,t)=>new Date(t.lastActivity).getTime()-new Date(e.lastActivity).getTime());d(e);let s=localStorage.getItem("activeSessionId");s&&e.some(e=>(e.session_id||e.id)===s)?(console.log("Found previous session in loaded sessions:",s),g(s)):e.length>0&&(console.log("No saved session found, selecting most recent session"),g(e[0].session_id||e[0].id))},[t,w,i]),(0,o.useEffect)(()=>{_.current&&setTimeout(()=>{var e;null==(e=_.current)||e.scrollIntoView({behavior:"smooth"})},100),m&&u.length>0&&D(m,u)},[u,m]),(0,o.useCallback)(async()=>{if(t)try{let{data:e,success:t}=await l.FH.get(l.Sn.CHAT.SESSIONS);if(t&&Array.isArray(e)){let t=[...e].sort((e,t)=>new Date(t.lastActivity).getTime()-new Date(e.lastActivity).getTime());d(t)}}catch(e){console.error("Failed to refresh sessions:",e)}},[t]);let z=(0,o.useCallback)(async()=>{if(t)try{y("");let{data:e,success:t}=await l.FH.post(l.Sn.CHAT.NEW_SESSION,{});if(t&&e){let t={id:e.session_id,name:e.name||"New Conversation",lastActivity:e.lastActivity||new Date().toISOString(),messages:[],session_id:e.session_id,topic:e.topic||"New Conversation"};return d(e=>[t,...e]),h([]),g(t.session_id),D(t.session_id,[]),localStorage.setItem("activeSessionId",t.session_id),P(!0),t.session_id}throw Error("Failed to create session")}catch(s){console.error("Failed to create new session:",s),y("Failed to create new chat session");let e="session-".concat(Date.now(),"-").concat(Math.random().toString(36).substring(2,9)),t={id:e,name:"New Conversation",lastActivity:new Date().toISOString(),messages:[],session_id:e,topic:"New Conversation"};return d(e=>[t,...e]),h([]),g(e),D(e,[]),localStorage.setItem("activeSessionId",e),P(!0),e}},[t]),R=async()=>{if(!f.trim()||!t||!m)return;let e=[...u,{sender:"user",text:f,timestamp:new Date().toISOString()}];D(m,e),localStorage.setItem("activeSessionId",m),h(e);let s=i.find(e=>e.session_id===m||e.id===m),a=s&&(!s.topic||"New Conversation"===s.topic||s.topic.startsWith("Chat ")||s.topic.startsWith("Conversation "));if(0===u.length&&a&&f)try{let e=E(f),t=i.map(t=>t.session_id===m||t.id===m?{...t,topic:e,name:e}:t);d(t)}catch(e){console.error("Error updating session topic:",e)}x(""),v(!0);try{let{data:t,success:s}=await l.FH.post(l.Sn.CHAT.MESSAGE,{session_id:m,message:f});if(s&&t){let s={sender:"grace",text:t.response||"",timestamp:new Date().toISOString()},a=[...e,s];if(D(m,a),localStorage.setItem("activeSessionId",m),h(a),H(m),t.topic)try{let e=i.map(e=>e.session_id===m||e.id===m?{...e,topic:t.topic,name:t.topic}:e);d(e)}catch(e){console.error("Error updating session with server topic:",e)}}else y("Failed to get response")}catch(t){console.error("Failed to send message:",t),y("Failed to send message"),D(m,e),localStorage.setItem("activeSessionId",m),h(e)}finally{v(!1),setTimeout(()=>{_.current&&_.current.scrollIntoView({behavior:"smooth"})},100)}},[J,L]=(0,o.useState)(!1),X=()=>{L(!J)};return(0,a.jsxs)("div",{className:"flex h-[calc(100vh-16rem)] overflow-hidden rounded-lg border border-red-700",children:[(0,a.jsx)("button",{className:"md:hidden absolute top-2 left-2 z-10 bg-red-800 rounded-full p-2 text-white shadow-md",onClick:X,children:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,a.jsx)("path",{fillRule:"evenodd",d:"M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z",clipRule:"evenodd"})})}),(0,a.jsxs)("aside",{className:"".concat(J?"block":"hidden"," md:block absolute md:relative md:w-64 w-3/4 bg-black border-r border-red-800 p-4 overflow-y-auto h-full z-10"),children:[(0,a.jsxs)("h2",{className:"text-red-300 text-lg font-mono mb-2 flex justify-between items-center",children:[(0,a.jsx)("span",{children:"Sessions"}),(0,a.jsx)("button",{onClick:X,className:"md:hidden text-red-300 hover:text-red-100",children:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,a.jsx)("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]}),(0,a.jsx)("button",{onClick:()=>{z(),L(!1)},className:"w-full mb-4 rounded bg-red-700 px-4 py-2 hover:bg-red-900",disabled:!t||p,children:"+ New Chat"}),b&&(0,a.jsx)("p",{className:"text-red-500 text-xs mb-2",children:b}),!t&&(0,a.jsx)("p",{className:"text-yellow-500 text-xs mb-2",children:"Please log in to use chat"}),(0,a.jsx)("ul",{className:"space-y-2",children:i.map(e=>{let t=e.session_id||e.id;return t?(0,a.jsx)("li",{className:"relative group",children:(0,a.jsx)("button",{onClick:()=>{h([]),g(t);let e=k(t);e.length>0&&h(e),localStorage.setItem("activeSessionId",t),L(!1)},className:"w-full text-left px-3 py-2 rounded text-sm hover:bg-red-800 ".concat(m===t?"bg-red-900 text-white":"text-red-300"),children:e.topic||e.name||"Chat ".concat(t.slice(0,6))})},t):null})})]}),J&&(0,a.jsx)("div",{className:"md:hidden fixed inset-0 bg-black bg-opacity-50 z-0",onClick:()=>L(!1)}),(0,a.jsxs)("main",{className:"flex-1 bg-black flex flex-col",children:[(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",onScroll:O,children:[0===u.length&&!p&&(0,a.jsx)("div",{className:"text-center text-gray-500 my-8",children:t?"No messages yet. Start a conversation!":"Please log in to start chatting"}),p&&(0,a.jsx)("div",{className:"text-center text-yellow-500 my-4 animate-pulse",children:"Grace is thinking..."}),u.map((e,t)=>(0,a.jsxs)("div",{className:"mb-4",children:["user"===e.sender||e.user?(0,a.jsxs)("div",{className:"text-right p-2 rounded-lg bg-red-900/30 text-red-300",children:[(0,a.jsx)("span",{className:"font-bold",children:"You:"})," ",e.text||e.user]}):null,"grace"===e.sender||e.bot?(0,a.jsxs)("div",{className:"text-left p-2 rounded-lg bg-green-900/30 text-green-300",children:[(0,a.jsx)("span",{className:"font-bold",children:"Grace:"})," ",e.text||e.bot]}):null]},t)),(0,a.jsx)("div",{ref:_})]}),(0,a.jsxs)("footer",{className:"flex border-t border-red-800 bg-black p-4",children:[(0,a.jsx)("textarea",{className:"flex-1 mr-2 rounded bg-white/10 p-2 text-white min-h-[60px] resize-none",placeholder:t?"Type your message... (Shift+Enter for new line)":"Please log in to chat",value:f,onChange:e=>x(e.target.value),onKeyDown:e=>{"Enter"===e.key&&!e.shiftKey&&(e.preventDefault(),!p&&t&&f.trim()&&R())},disabled:!t||p,autoFocus:!0,"aria-label":"Chat message input",ref:e=>{e&&t&&!p&&setTimeout(()=>e.focus(),100)}}),(0,a.jsx)("button",{onClick:R,disabled:p||!t||!f.trim(),className:"rounded bg-red-700 px-4 py-2 hover:bg-red-900 disabled:bg-gray-700 disabled:cursor-not-allowed",children:p?"...":"Send"})]}),(0,a.jsx)("div",{className:"border-t border-red-800/50 p-4 bg-black/70",children:(0,a.jsxs)("div",{className:"bg-transparent text-white p-4",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,a.jsx)("h3",{className:"flex items-center text-red-500 font-bold relative pl-4 before:content-[''] before:absolute before:left-0 before:top-0 before:h-full before:w-1 before:bg-red-500",children:"XFeed Channel"}),(0,a.jsxs)("button",{onClick:()=>{let e=document.querySelector("[data-xfeed-settings]");e&&e instanceof HTMLElement&&e.click()},className:"text-xs px-2 py-1 rounded bg-red-900/50 text-red-200 hover:bg-red-800 flex items-center space-x-1",children:[(0,a.jsx)("span",{className:"text-lg leading-none",children:"+"}),(0,a.jsx)("span",{children:"Add Account"})]})]}),(0,a.jsx)("hr",{className:"border-gray-800 mb-4"}),(0,a.jsx)(S,{maxItems:3})," "]})})]})]})}},904:(e,t,s)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/chat",function(){return s(356)}])}},e=>{e.O(0,[317,100,636,593,792],()=>e(e.s=904)),_N_E=e.O()}]);
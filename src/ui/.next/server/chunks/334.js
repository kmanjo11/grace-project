exports.id=334,exports.ids=[334],exports.modules={556:(a,b,c)=>{"use strict";c.r(b),c.d(b,{default:()=>m});var d=c(8732),e=c(2015),f=c(1946),g=c.n(f),h=c(1013),i=c(3777),j=c(7550),k=c(5803);function l(){let a=(0,h.useRouter)(),{logout:b}=(0,i.A)(),c=async()=>{try{k.A.clearSnapshot(),await b(),a.push("/login")}catch(b){console.error("Logout failed:",b),a.push("/login")}};return(0,d.jsx)("button",{onClick:c,className:"transition-all hover:text-red-400 pb-1 text-white",children:"Logout"})}function m({children:a}){let{pathname:b}=(0,h.useRouter)(),{user:c}=(0,i.A)(),[f,k]=(0,e.useState)(!1),{dispatch:m,hydrateFromStorage:n}=(0,j.A)();return(0,d.jsxs)("div",{className:"min-h-screen bg-gradient-to-b from-[#140000] to-black text-white flex flex-col items-center",children:[(0,d.jsxs)("header",{className:"w-full max-w-screen-md text-center border-b border-red-700 pb-1 mb-2",children:[(0,d.jsx)("img",{src:"/assets/grace_logo_gold.png",alt:"Grace Logo",className:"w-48 md:w-56 mx-auto mt-2 mb-1"}),(0,d.jsx)("button",{className:"md:hidden absolute right-4 top-6 text-white p-2",onClick:()=>k(!f),children:(0,d.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,d.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:f?"M6 18L18 6M6 6l12 12":"M4 6h16M4 12h16M4 18h16"})})}),(0,d.jsxs)("nav",{className:`
          ${f?"flex":"hidden"} 
          md:flex 
          flex-col md:flex-row 
          justify-center 
          md:space-x-6 md:space-y-0 
          space-y-4 
          text-red-300 text-lg md:text-xl font-mono
          w-full 
          pb-1
        `,children:[[{name:"Chat",path:"/chat"},{name:"Wallet",path:"/wallet"},{name:"Trading",path:"/trading"},{name:"Social",path:"/social"},{name:"Settings",path:"/settings"}].map(a=>(0,d.jsx)(g(),{href:a.path,onClick:()=>k(!1),className:`transition-all hover:text-red-400 pb-1 ${b===a.path?"text-red-300 border-b border-red-500":"text-white"}`,children:a.name},a.path)),(0,d.jsx)(l,{})]})]}),(0,d.jsx)("main",{className:"w-full max-w-screen-md px-4 py-3 flex-grow",children:a})]})}},3777:(a,b,c)=>{"use strict";c.d(b,{O:()=>k,A:()=>l});var d=c(8732),e=c(2015),f=c(4049),g=c(6678);let h="1"==="1".toString()||"true"==="1".toString().toLowerCase(),i={STORAGE_KEY:"GRACE_SESSION_SNAPSHOT",captureSnapshot(a,b){try{if(h)return;if(!a||!b)return void this.clearSnapshot();Date.now(),a.id,a.username,a.email}catch(a){console.warn("Failed to capture session snapshot",a)}},retrieveSnapshot(){try{if(h);return{user:null,token:null}}catch(a){return console.warn("Failed to retrieve session snapshot",a),this.clearSnapshot(),{user:null,token:null}}},clearSnapshot(){try{if(h)return}catch(a){console.warn("Failed to clear session snapshot",a)}}},j=(0,e.createContext)(null);function k({children:a}){let[b,c]=(0,e.useState)(null),[k,l]=(0,e.useState)(!0),[m,n]=(0,e.useState)(!1),[o,p]=(0,e.useState)((0,g.c4)()),[q,r]=(0,e.useState)(!1);(0,e.useRef)(0),(0,e.useRef)(null),(0,e.useRef)(0);let s=(a,b={})=>{let c={timestamp:new Date().toISOString(),eventType:a,...b};console.log(JSON.stringify(c));try{h||JSON.parse("[]").push(c)}catch(a){console.error("Failed to log authentication event",a)}},t=async()=>{try{if(!m||!o)return;let a=await f.Ay.get(f.Sn.WALLET.INFO,{});if(a.success&&a.data?.wallet?.wallet_address)return console.log("User wallet already exists:",a.data?.wallet?.wallet_address),a.data?.wallet;{console.log("No wallet found for user, generating a new internal wallet...");let a=await f.Ay.post(f.Sn.WALLET.GENERATE,{});if(a.success)return console.log("Wallet generated successfully:",a.data?.wallet?.wallet_address),a.data?.wallet;console.error("Failed to generate wallet:",a.error)}}catch(a){console.error("Error checking/generating wallet:",a instanceof Error?a.message:"Unknown error")}},u=async(a=0)=>{try{if(s("TOKEN_REFRESH_ATTEMPT",{retryCount:a}),a>0){let b=1e3*Math.pow(2,a)*(1+Math.random());await new Promise(a=>setTimeout(a,b))}let b=await f.Ay.post(f.Sn.AUTH.REFRESH_TOKEN,{});if(!b.success)throw Error("Token refresh failed: Unsuccessful response");let d=(0,g.c4)()||b.data?.token||null;if(!d)throw Error("Token refresh failed: No token available after refresh");let e=null!==localStorage.getItem(g.il);b.data?.token&&await (0,g.NQ)(d,e),p(d),n(!0);let h=b.data?.username;return h&&c(a=>({...a,username:h})),s("TOKEN_REFRESH_SUCCESS",{username:h}),!0}catch(b){if(s("TOKEN_REFRESH_FAILURE",{errorMessage:b instanceof Error?b.message:"Unknown refresh error",retryCount:a,errorStack:b instanceof Error?b.stack:void 0}),a<3)return console.warn(`Token refresh attempt ${a+1} failed. Retrying...`),u(a+1);return console.error("Token refresh failed after maximum retries"),w(),!1}},v=async a=>{try{if(console.log("AuthContext: login function called with data:",a),!a.token){let b=(0,g.c4)();if(console.log("AuthContext: token missing in payload, using stored token:",!!b),b)a.token=b;else throw Error("No token found in login data or storage")}console.log("AuthContext: Processing login with token");let b=void 0===a.remember_me||a.remember_me;return await (0,g.NQ)(a.token,b),console.log("AuthContext: Token stored successfully"),p(a.token),c(a.user||{}),n(!0),l(!1),console.log("AuthContext: State updated - isAuthenticated: true, user:",a.user),a.user&&i.captureSnapshot(a.user,a.token),r(!0),console.log("AuthContext: Login complete, auth state updated"),setTimeout(()=>{t()},500),!0}catch(a){return console.error("Login failed:",a instanceof Error?a.message:"Unknown error"),(0,g.SZ)(),i.clearSnapshot(),p(null),c(null),n(!1),l(!1),!1}},w=async()=>{s("logout_initiated");try{(0,g.c4)()&&await f.Ay.post(f.Sn.AUTH.LOGOUT,{})}catch(a){console.error("Error during logout:",a)}finally{(0,g.SZ)(),p(null),c(null),n(!1),i.clearSnapshot(),s("logout_complete")}};return(0,d.jsx)(j.Provider,{value:{user:b,login:v,logout:w,loading:k,refreshToken:u,isAuthenticated:m},children:a})}let l=()=>{let a=(0,e.useContext)(j);if(!a)throw Error("useAuth must be used within an AuthProvider");return a}},4049:(a,b,c)=>{"use strict";c.d(b,{Ay:()=>l,FH:()=>i,S1:()=>k,Sn:()=>f,c4:()=>d.c4,rh:()=>j});var d=c(6678);class e extends Error{statusCode;data;constructor(a,b,c){super(a),this.name="ApiError",this.statusCode=b,this.data=c}}let f={AUTH:{LOGIN:"/api/auth/login",REGISTER:"/api/auth/register",VERIFY_TOKEN:"/api/auth/verify",LOGOUT:"/api/auth/logout",REFRESH_TOKEN:"/api/auth/refresh-token",FORGOT_PASSWORD:"/api/auth/forgot-password",RESET_PASSWORD:"/api/auth/reset-password"},USER:{PROFILE:"/api/user/profile",LEVERAGE_POSITIONS:"/api/user/leverage_positions",SPOT_POSITIONS:"/api/user/spot_positions",POSITION_HISTORY:"/api/user/position_history",TRADE_HISTORY:"/api/user/trade_history",LIMIT_ORDERS:"/api/limit-orders"},WALLET:{DATA:"/api/wallet/data",INFO:"/api/wallet/info",MANGO_BALANCE:"/api/wallet/mango-balance",GENERATE:"/api/wallet/generate",SEND:"/api/wallet/send",CONNECT_PHANTOM:"/api/wallet/phantom/connect",COMPLETE_PHANTOM:"/api/wallet/phantom/callback",DISCONNECT_PHANTOM:"/api/wallet/phantom/disconnect",BALANCE:"/api/wallet/info",TRANSACTIONS:"/api/wallet/transactions"},CHAT:{SESSIONS:"/api/chat/sessions",NEW_SESSION:"/api/chat/session/new",HISTORY:a=>`/api/chat/history/${a}`,MESSAGE:"/api/chat/message"},SOCIAL:{SENTIMENT:"/api/social/sentiment",TRENDING:"/api/social/trending-topics",INFLUENTIAL:"/api/social/influential",TWEETS:"/api/social/tweets"},MANGO:{BASE:"/api/mango",OHLCV:"/api/mango/ohlcv",MARKETS:"/api/mango/markets",ORDER_BOOK:"/api/mango/orderbook",TRADES:"/api/mango/trades",MARKET_STATS:"/api/mango/market-stats",COMMUNITIES:"/api/social/communities",ENTITIES:"/api/social/entities",FEED:"/api/social/feed",CONNECTIONS:"/api/social/connections"},TRADING:{EXECUTE:"/api/trading/execute",CONFIRM:"/api/trading/confirm",SMART_SETTINGS:"/api/trading/smart-settings",TOKENS:"/api/trading/tokens",PRICE_CHART:"/api/trading/price-chart",SWAP:"/api/trading/swap",SELL_POSITION:"/api/trading/sell-position",USER_POSITIONS:"/api/user/positions",LEVERAGE_POSITIONS:"/api/user/leverage_positions",SPOT_POSITIONS:"/api/user/spot_positions"},SETTINGS:{PROFILE:"/api/user/settings",NOTIFICATIONS:"/api/settings/notifications",TRADING_SETTINGS:"/api/trading/smart-settings"}};async function g(a){try{let b,c=a.clone(),e=await a.text();try{(b=e?JSON.parse(e):void 0)&&b.token&&await (0,d.NQ)(b.token,!0)}catch(b){if(!a.ok)return{success:!1,error:e||"Invalid response format",statusCode:a.status,rawResponse:c};return{success:!0,data:e,statusCode:a.status,rawResponse:c}}if(!a.ok)return{success:!1,error:b?.message||b?.error||`HTTP error ${a.status}`,statusCode:a.status,data:b,rawResponse:c};return{success:!0,data:function(a){if(a&&"object"==typeof a&&"token"in a){let{token:b,...c}=a;return c}return a&&"object"==typeof a&&"success"in a?a:a&&"object"==typeof a&&"results"in a?{success:!0,data:a.results,...a}:a.results?a.results:a.data&&void 0===a.success?a.data:a}(b),statusCode:a.status,rawResponse:c}}catch(b){return console.error("Error processing response:",b),{success:!1,error:b instanceof Error?b.message:"Unknown error processing response",rawResponse:a.clone()}}}async function h(a,b={}){try{let c=(()=>{let a="http://localhost:9000";return a&&""!==a.trim()?a.endsWith("/")?a.slice(0,-1):a:""})(),e=a.startsWith("http")?a:`${c}${a}`;console.log("API Request:",{baseUrl:c,endpoint:a,url:e});let f=(0,d._E)({...b,credentials:"include",headers:{...b.headers,"Content-Type":"application/json"}});console.log("Making fetch request to:",e,"with options:",f);let h=await fetch(e,f);return console.log("Response received:",h.status,h.statusText),await g(h)}catch(a){if(a instanceof e)throw a;throw new e(a instanceof Error?a.message:"Network error",0)}}let i={get:async(a,b={})=>h(a,{...b,method:"GET"}),post:async(a,b,c={})=>h(a,{...c,method:"POST",body:JSON.stringify(b)}),put:async(a,b,c={})=>h(a,{...c,method:"PUT",body:JSON.stringify(b)}),delete:async(a,b={})=>h(a,{...b,method:"DELETE"})},j={async getSessions(a,b){try{let c=new URLSearchParams;a&&c.append("limit",a.toString()),b&&c.append("offset",b.toString());let d=c.toString(),e=d?`${f.CHAT.SESSIONS}?${d}`:f.CHAT.SESSIONS,g=await i.get(e),h=Array.isArray(g.data)?g.data:[];return{sessions:h,total:h.length,has_more:!1}}catch(b){let a=b.response?.data?.error||"Failed to fetch chat sessions";throw console.error("Error fetching chat sessions:",a,{usingFallback:b.response?.data?.using_fallback}),Error(a)}},async createSession(a){try{let b=await i.post(f.CHAT.NEW_SESSION,{title:a||"New Chat"});if(!b.data?.session_id)throw Error("Invalid response format from server");return{session_id:b.data.session_id}}catch(a){throw console.error("Error creating chat session:",a),Error("Failed to create chat session")}},async getHistory(a,b,c){try{let d=new URLSearchParams;b&&d.append("limit",b.toString()),c&&d.append("offset",c.toString());let e=d.toString(),g=e?`${f.CHAT.HISTORY(a)}?${e}`:f.CHAT.HISTORY(a),h=await i.get(g),j=Array.isArray(h.data)?h.data:[];return{messages:j,total:j.length,has_more:!1}}catch(b){let a=b.response?.data?.error||"Failed to fetch chat history";throw console.error("Error fetching chat history:",a,{usingFallback:b.response?.data?.using_fallback}),Error(a)}},async sendMessage(a,b,c){try{let d=(await i.post(f.CHAT.MESSAGE,{session_id:a,message:b,timestamp:new Date().toISOString(),...c&&{metadata:c}})).data||{};return{response:d.response||d.message||d.content||"",metadata:d.metadata,session_id:d.session_id||a,message_id:d.message_id||`msg_${Date.now()}`,timestamp:d.timestamp||new Date().toISOString()}}catch(b){let a=b.response?.data?.error||"Failed to send chat message";throw console.error("Error sending chat message:",a,{usingFallback:b.response?.data?.using_fallback}),Error(a)}}},k={async executeTrade(a){try{return(await i.post("/api/trading/execute",{...a,amount:a.amount.toString()})).data}catch(a){throw console.error("Trade execution failed:",a),Error(a.response?.data?.error||"Trade execution failed")}},async confirmTrade(a){try{return(await i.post("/api/trading/confirm",{confirmation_id:a})).data}catch(a){throw console.error("Trade confirmation failed:",a),Error(a.response?.data?.error||"Trade confirmation failed")}},async closePosition(a){try{return(await i.post("/api/trading/sell-position",a)).data}catch(a){throw console.error("Position closing failed:",a),Error(a.response?.data?.error||"Failed to close position")}},async sellToken(a){try{return(await i.post("/api/trading/sell-token",{...a,amount:a.amount.toString()})).data}catch(a){throw console.error("Token selling failed:",a),Error(a.response?.data?.error||"Failed to sell token")}},async sellPosition(a){try{let b={...a};return a.percentage&&a.percentage>0&&a.percentage<100&&(b.amount=a.amount*a.percentage/100),(await i.post(f.TRADING.SELL_POSITION,b)).data}catch(a){throw console.error("Failed to close position:",a),Error(a.response?.data?.error||"Failed to close position")}},async getUserLeveragePositions(){try{let a=await i.get(f.USER.LEVERAGE_POSITIONS);if(a.data&&"object"==typeof a.data&&"success"in a.data)return a.data;let b=Array.isArray(a.data)?a.data:[];return{success:!0,positions:b,metadata:{total_positions:b.length,timestamp:new Date().toISOString()}}}catch(a){return console.error("Error fetching leverage positions:",a),{success:!1,positions:[],error:{message:a instanceof Error?a.message:"Failed to fetch leverage positions",code:"POSITION_FETCH_ERROR"}}}},async getUserSpotPositions(){try{let a=await i.get(f.USER.SPOT_POSITIONS);if(a.data&&"object"==typeof a.data&&"success"in a.data)return a.data;let b=Array.isArray(a.data)?a.data:[];return{success:!0,positions:b,metadata:{total_positions:b.length,timestamp:new Date().toISOString()}}}catch(a){return console.error("Error fetching spot positions:",a),{success:!1,positions:[],error:{message:a instanceof Error?a.message:"Failed to fetch spot positions",code:"POSITION_FETCH_ERROR"}}}},getPositionHistory:async a=>{try{let b=new URLSearchParams;a?.market&&b.append("market",a.market),a?.startTime&&b.append("start_time",String(a.startTime)),a?.endTime&&b.append("end_time",String(a.endTime)),a?.interval&&b.append("interval",a.interval),a?.includePnl!==void 0&&b.append("include_pnl",String(a.includePnl)),a?.includeLivePnl&&b.append("include_live_pnl","true"),a?.cursor&&b.append("cursor",a.cursor),a?.limit&&b.append("limit",String(a.limit));let c=await fetch(`${f.USER.POSITION_HISTORY}?${b.toString()}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${(0,d.c4)()}`}}),g=await c.json();if(!c.ok){let a=g?.error||{};throw new e(a.message||`HTTP error! status: ${c.status}`,c.status,{code:a.code||"api_error",status:a.status||c.status,timestamp:a.timestamp||new Date().toISOString(),...a.details&&{details:a.details}})}return{success:g.success,position_history:g.position_history||[],pnl_over_time:g.pnl_over_time||[],pagination:g.pagination||{has_more:g.metadata?.has_more||!1,next_cursor:g.metadata?.cursor,limit:a?.limit||100,total:g.metadata?.total||0},metadata:{user_identifier:g.metadata?.user_identifier||"",market:a?.market||"all",start_time:g.metadata?.start_time||new Date().toISOString(),end_time:g.metadata?.end_time||new Date().toISOString(),interval:a?.interval||"1d",total_positions:g.metadata?.total||0,has_more:g.metadata?.has_more||!1,cursor:g.metadata?.cursor}}}catch(b){if(console.error("Error fetching position history:",b),b instanceof e)return{success:!1,position_history:[],pnl_over_time:[],pagination:{has_more:!1,next_cursor:void 0,limit:a?.limit||100,total:0},metadata:{user_identifier:"",market:a?.market||"all",start_time:new Date().toISOString(),end_time:new Date().toISOString(),interval:a?.interval||"1d",total_positions:0,has_more:!1},error:b.message,error_details:b.data};return{success:!1,position_history:[],pnl_over_time:[],pagination:{has_more:!1,next_cursor:void 0,limit:a?.limit||100,total:0},metadata:{user_identifier:"",market:a?.market||"all",start_time:new Date().toISOString(),end_time:new Date().toISOString(),interval:a?.interval||"1d",total_positions:0,has_more:!1},error:b instanceof Error?b.message:"Unknown error",error_details:{code:"unexpected_error",status:500,timestamp:new Date().toISOString()}}}},getPositionDetails:async(a,b)=>{try{let c=new URLSearchParams({positionId:a});b?.startTime&&c.append("startTime",String(b.startTime)),b?.endTime&&c.append("endTime",String(b.endTime)),b?.interval&&c.append("interval",b.interval);let e=`${f.USER.POSITION_HISTORY}/details?${c.toString()}`,g=(0,d._E)(),h=new Headers;h.append("Content-Type","application/json"),g&&Object.entries(g).forEach(([a,b])=>{b&&h.append(a,b)});let j=await i.get(e,{headers:h});if(!j.success)throw Error(j.error||"Failed to fetch position details");return j.data.data}catch(a){throw console.error("Error fetching position details:",a),a}}},l=i},5334:(a,b,c)=>{"use strict";c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{default:()=>q});var e=c(8732),f=c(2015),g=c(3777),h=c(7550),i=c(7856),j=c(6055),k=c(4391),l=c(556);c(9803),c(5757),c(9319);var m=c(8462),n=c(7207);c(9104);var o=a([k,m,n]);[k,m,n]=o.then?(await o)():o;let r=["/chat","/wallet","/trading","/social","/settings"],s=["/","/login","/register","/forgot","/reset"];function p({children:a,router:b}){let{user:c,loading:d,isAuthenticated:h}=(0,g.A)(),i=s.includes(b.pathname),[k,l]=(0,f.useState)(!1);return((0,f.useRef)(0),(0,f.useRef)(!1),d)?(0,e.jsx)(j.A,{message:"Loading authentication..."}):k?(0,e.jsx)(j.A,{message:"Navigating..."}):d||c||i?(0,e.jsx)(e.Fragment,{children:a}):(0,e.jsx)(j.A,{message:"Redirecting to login..."})}function q({Component:a,pageProps:b,router:c}){let d=r.includes(c.pathname),j=(0,f.useMemo)(()=>new m.QueryClient({defaultOptions:{queries:{staleTime:3e4,gcTime:3e5,refetchOnWindowFocus:!1}}}),[]);return(0,e.jsx)(i.A,{componentName:"Main App",children:(0,e.jsx)(g.O,{children:(0,e.jsx)(h.m,{children:(0,e.jsxs)(m.QueryClientProvider,{client:j,children:[(0,e.jsxs)(p,{router:c,children:[d?(0,e.jsx)(l.default,{children:(0,e.jsx)(a,{...b})}):(0,e.jsx)(a,{...b}),(0,e.jsx)(k.ToastContainer,{position:"bottom-right",theme:"dark"})]}),(0,e.jsx)(n.ReactQueryDevtools,{initialIsOpen:!1})]})})})})}d()}catch(a){d(a)}})},5803:(a,b,c)=>{"use strict";c.d(b,{A:()=>g});class d{static instance;activeLocks=new Map;DEFAULT_TIMEOUT=5e3;constructor(){}static getInstance(){return d.instance||(d.instance=new d),d.instance}acquireLock(a,b,c=this.DEFAULT_TIMEOUT){if(this.cleanExpiredLocks(),this.activeLocks.has(a))return console.debug(`StateOperationLock: Resource ${a} already locked for operation: ${this.activeLocks.get(a)?.operation}`),null;let d=`lock_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,e=Date.now(),f={id:d,operation:b,acquiredAt:e,expiresAt:e+c};return this.activeLocks.set(a,f),console.debug(`StateOperationLock: Lock acquired for ${a}: ${b}`),f.timeoutId=setTimeout(()=>{let b=this.activeLocks.get(a);b&&b.id===d&&(this.activeLocks.delete(a),console.debug(`StateOperationLock: Lock auto-released for ${a}`))},c),d}releaseLock(a,b){let c=this.activeLocks.get(a);return c?c.id!==b?(console.debug(`StateOperationLock: Lock ID mismatch for ${a}: expected ${c.id}, got ${b}`),!1):(this.activeLocks.delete(a),c.timeoutId&&clearTimeout(c.timeoutId),console.debug(`StateOperationLock: Lock released for ${a}`),!0):(console.debug(`StateOperationLock: No active lock for ${a} (already released?)`),!1)}isLocked(a){return this.cleanExpiredLocks(),this.activeLocks.has(a)}cleanExpiredLocks(){let a=Date.now();for(let[b,c]of this.activeLocks.entries())c.expiresAt<a&&(console.debug(`StateOperationLock: Lock for ${b} expired and was auto-released`),this.activeLocks.delete(b))}}let e=d.getInstance();class f{static getStoredState(){throw Error("Method not implemented.")}static STORAGE_KEY="GRACE_DYNAMIC_SNAPSHOT";static MAX_SNAPSHOT_AGE=864e5;static STORAGE_VERSION=1;static MAX_STORAGE_SIZE=4194304;static LAST_WARN_AT=0;static WARN_COOLDOWN_MS=2e3;static log(a,b="info"){let c=new Date().toISOString(),d=`[StatePersistence:${b.toUpperCase()}] ${c} - ${a}`;switch(b){case"info":console.log(d);break;case"warn":console.warn(d);break;case"error":console.error(d)}}static async checkStorageQuota(){try{if("storage"in navigator&&"estimate"in navigator.storage){let{usage:a,quota:b}=await navigator.storage.estimate();if(a&&b){let c=a/b;if(this.log(`Storage usage: ${(100*c).toFixed(2)}% (${Math.round(a/1024/1024)}MB / ${Math.round(b/1024/1024)}MB)`),c>.9)return this.log("Storage quota nearing limit, cleaning up old data","warn"),this.cleanupStorage()}}else{let a=0;for(let b=0;b<localStorage.length;b++){let c=localStorage.key(b);if(c){let b=localStorage.getItem(c)||"";a+=c.length+b.length}}let b=a/1048576;if(this.log(`Estimated localStorage usage: ${b.toFixed(2)}MB`),a>this.MAX_STORAGE_SIZE)return this.log("Storage size nearing limit, cleaning up old data","warn"),this.cleanupStorage()}return!0}catch(a){return this.log(`Error checking storage quota: ${a}`,"error"),!0}}static cleanupStorage(){try{let a=[];for(let b=0;b<localStorage.length;b++){let c=localStorage.key(b);c&&(c.startsWith("messages_")||c.includes("draft_"))&&a.push(c)}let b=a.map(a=>{let b=String(a).replace("messages_","").replace("draft_",""),c=localStorage.getItem(`lastSynced_${b}`),d=c?new Date(c).getTime():0;return{key:a,timestamp:d}});b.sort((a,b)=>a.timestamp-b.timestamp);let c=Math.ceil(.3*b.length);for(let a=0;a<c;a++)a<b.length&&(localStorage.removeItem(b[a].key),this.log(`Removed old data: ${b[a].key}`));let d=localStorage.getItem(this.STORAGE_KEY);if(d&&d.length>1048576)try{let a=JSON.parse(d);a.chatContext&&a.chatContext.messages&&(a.chatContext.messages=a.chatContext.messages.slice(-20)),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(a)),this.log("Trimmed main snapshot size")}catch(a){this.log(`Error trimming snapshot: ${a}`,"error")}return!0}catch(a){return this.log(`Error cleaning up storage: ${a}`,"error"),!1}}static validateSnapshotSchema(a){if(!a||"object"!=typeof a||"number"!=typeof a.timestamp)return!1;for(let b of["userSession","chatContext","pageState","widgetStates"])if(!a[b]||"object"!=typeof a[b])return!1;return!0}static createBackup(){try{let a=localStorage.getItem(this.STORAGE_KEY);a&&localStorage.setItem(`${this.STORAGE_KEY}_BACKUP`,a)}catch(a){this.log(`Failed to create backup: ${a}`,"warn")}}static async captureSnapshot(a){let b=e.acquireLock("state_snapshot","capture_snapshot");if(!b)return void this.log("Could not acquire lock for state operation, another operation is in progress","warn");try{if(!this.isStorageAvailable())return void this.log("Local storage not available","warn");await this.checkStorageQuota()||this.log("Storage quota issues, data may not be saved completely","warn");let b=this.retrieveSnapshot(),c={timestamp:Date.now(),version:this.STORAGE_VERSION,userSession:a?.userSession||b?.userSession||{},chatContext:a?.chatContext||b?.chatContext||{},pageState:a?.pageState||b?.pageState||{},widgetStates:a?.widgetStates||b?.widgetStates||{}};this.createBackup();try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(c)),this.log("State snapshot captured successfully")}catch(b){this.log(`Storage error, forcing cleanup: ${b}`,"warn"),this.cleanupStorage();let a={timestamp:Date.now(),version:this.STORAGE_VERSION,userSession:c.userSession,chatContext:{currentConversationId:c.chatContext.currentConversationId},pageState:{lastVisitedPath:c.pageState.lastVisitedPath},widgetStates:{}};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(a)),this.log("Minimal state snapshot saved as fallback")}}catch(a){this.log(`Failed to capture state snapshot: ${a}`,"error")}finally{e.releaseLock("state_snapshot",b)}}static isStorageAvailable(){try{let a="__storage_test__";return localStorage.setItem(a,a),localStorage.removeItem(a),!0}catch(a){return!1}}static validateSnapshot(a){return!!a&&(this.validateSnapshotSchema(a)?!(Date.now()-a.timestamp>this.MAX_SNAPSHOT_AGE)||(this.log("Snapshot too old, discarding","warn"),!1):(this.log("Snapshot has invalid schema, discarding","warn"),!1))}static retrieveSnapshot(){if(e.isLocked("state_snapshot")){let a=Date.now();a-this.LAST_WARN_AT>this.WARN_COOLDOWN_MS?(this.log("State snapshot is currently being updated, using existing snapshot","warn"),this.LAST_WARN_AT=a):console.debug("[StatePersistence:DEBUG] snapshot update in progress (throttled)")}try{let a=localStorage.getItem(this.STORAGE_KEY);if(!a)return null;try{let b=JSON.parse(a);if(this.validateSnapshot(b))return b;return this.log("Invalid snapshot detected, attempting recovery","warn"),this.attemptSnapshotRecovery()}catch(a){return this.log(`JSON parse error: ${a}, attempting recovery`,"error"),this.attemptSnapshotRecovery()}}catch(a){return this.log(`Failed to retrieve state snapshot: ${a}`,"error"),null}}static attemptSnapshotRecovery(){try{this.log("Attempting state recovery","warn");let a=localStorage.getItem(`${this.STORAGE_KEY}_BACKUP`);if(a)try{let b=JSON.parse(a);if(this.validateSnapshot(b))return this.log("Recovered state from backup","info"),b}catch(a){this.log("Backup snapshot also corrupted","warn")}let b={timestamp:Date.now(),version:this.STORAGE_VERSION,userSession:{},chatContext:{},pageState:{},widgetStates:{}},c=localStorage.getItem("activeSessionId");return c&&(b.chatContext.currentConversationId=c),b.recovered=!0,this.log("Created minimal recovered state","info"),b}catch(a){return this.log(`Recovery failed: ${a}`,"error"),null}}static hydrateState(a){let b=this.retrieveSnapshot();if(b){if(a&&b.pageState.lastVisitedPath)try{let c=b.pageState.lastVisitedPath,d=a.asPath||a.pathname||"/",e=Date.now(),f=sessionStorage.getItem("GRACE_NAV_META"),g="",h=0;if(f)try{({lastPath:g,lastAt:h}=JSON.parse(f))}catch{}let i=e-(h||0)<1e3;c===d||i&&c===g||(sessionStorage.setItem("GRACE_NAV_META",JSON.stringify({lastPath:c,lastAt:e})),a.push(c))}catch{}return b}return{}}static clearSnapshot(){localStorage.removeItem(this.STORAGE_KEY)}}let g=f},6055:(a,b,c)=>{"use strict";c.d(b,{A:()=>e});var d=c(8732);function e({message:a="Loading...",showLogo:b=!0}){return(0,d.jsx)("div",{className:"flex min-h-screen items-center justify-center bg-black text-white p-4",children:(0,d.jsxs)("div",{className:"text-center",children:[b&&(0,d.jsx)("div",{className:"mb-4 text-red-500 text-xl font-bold",children:"Grace"}),(0,d.jsxs)("div",{className:"flex items-center justify-center",children:[(0,d.jsx)("span",{className:"mr-2",children:a}),(0,d.jsx)("div",{className:"animate-pulse",children:"..."})]})]})})}c(2015)},6678:(a,b,c)=>{"use strict";c.d(b,{NQ:()=>e,SZ:()=>g,_E:()=>h,c4:()=>f,il:()=>d});let d="grace_auth_token";async function e(a,b=!1){}function f(){return null}function g(){}function h(a={}){let b=f(),c={...a.headers,"Content-Type":"application/json"};return b&&(c.Authorization=`Bearer ${b}`),{...a,headers:c}}Promise.resolve()},7550:(a,b,c)=>{"use strict";c.d(b,{A:()=>l,m:()=>k});var d=c(8732),e=c(2015),f=c(5803),g=c(3777);let h={timestamp:Date.now(),userSession:{},authSession:{},chatContext:{currentConversationId:void 0,draftMessage:"",lastMessageTimestamp:0},chatState:{activeSessions:[],sessions:{},draftMessages:{}},pageState:{},widgetStates:{},isHydrated:!1,isLoading:!1,lastSaved:0,tradingState:{},walletState:{},socialState:{},uiState:{darkMode:!0,sidebarOpen:!0},xfeed:{followedAccounts:[],lastUpdated:void 0}};function i(a,b){switch(b.type){case"SET_TRADING_STATE":return{...a,tradingState:{...a.tradingState,...b.payload}};case"SET_WALLET_STATE":return{...a,walletState:{...a.walletState,...b.payload}};case"SET_CHAT_STATE":return{...a,chatState:{...a.chatState,...b.payload}};case"SET_SOCIAL_STATE":return{...a,socialState:{...a.socialState,...b.payload}};case"SET_UI_STATE":return{...a,uiState:{...a.uiState,...b.payload}};case"SET_PAGE_STATE":return{...a,pageState:{...a.pageState,...b.payload}};case"SET_WIDGET_STATES":return{...a,widgetStates:{...a.widgetStates,...b.payload}};case"SET_CHAT_CONTEXT":return{...a,chatContext:{...a.chatContext,...b.payload}};case"SET_USER_SESSION":return{...a,userSession:{...a.userSession,...b.payload}};case"UPDATE_AUTH":let{user:c,token:d}=b.payload;return{...a,userSession:{...a.userSession,token:d||"",username:c?.username||""},authSession:{...a.authSession,token:d||"",expiresAt:d?Math.floor(Date.now()/1e3)+86400:void 0}};case"UPDATE_XFEED":return{...a,xfeed:{...a.xfeed,...b.payload,lastUpdated:Date.now()}};case"HYDRATE_STATE":case"HYDRATE":return{...b.payload};case"RESET_STATE":case"RESET":return h;default:return a}}let j=(0,e.createContext)(void 0);function k({children:a}){let[b,c]=(0,e.useReducer)(i,h),[k,l]=(0,e.useState)(!0),[m,n]=(0,e.useState)(!1),[o,p]=(0,e.useState)(!1),[q,r]=(0,e.useState)(!1);(0,e.useRef)(!1);let s="1"==="1".toString()||"true"==="1".toString().toLowerCase(),{user:t,isAuthenticated:u}=(0,g.A)(),v=(0,e.useCallback)(async a=>{try{if(s){n(!0),l(!1);return}l(!0);let b=f.A.retrieveSnapshot();if(!b){console.log("No stored state found"),n(!0);return}console.log("Hydrating state from storage:",b);let d={timestamp:b.timestamp||Date.now(),isHydrated:!0,lastSaved:0,userSession:{token:"",username:b.userSession?.username||""},chatContext:{currentConversationId:b.chatContext?.currentConversationId,draftMessage:b.chatContext?.draftMessage||"",lastMessageTimestamp:b.chatContext?.lastMessageTimestamp||0},pageState:{lastVisitedPath:b.pageState?.lastVisitedPath||"/",scrollPositions:b.pageState?.scrollPositions||{}},widgetStates:{tradingPositions:b.widgetStates?.tradingPositions||[],walletBalance:b.widgetStates?.walletBalance||0},chatState:{activeSessions:b.chatState?.activeSessions||[],currentSessionId:b.chatState?.currentSessionId,sessions:b.chatState?.sessions||{},draftMessages:b.chatState?.draftMessages||{}},tradingState:b.tradingState?{selectedToken:b.tradingState.selectedToken,watchlist:b.tradingState.watchlist||[],tradeHistory:b.tradingState.tradeHistory||[],tradeForm:b.tradingState.tradeForm,resolution:b.tradingState.resolution,search:b.tradingState.search,positions:b.tradingState.positions||[]}:{},walletState:b.walletState?{connectedWallets:b.walletState.connectedWallets||[],transactions:b.walletState.transactions||[]}:{},socialState:b.socialState?{posts:b.socialState.posts||[],following:b.socialState.following||[],notifications:b.socialState.notifications||[]}:{},uiState:{darkMode:b.uiState?.darkMode??!0,sidebarOpen:b.uiState?.sidebarOpen??!0,activeTabs:b.uiState?.activeTabs||{}},xfeed:{followedAccounts:[],lastUpdated:void 0}};c({type:"HYDRATE_STATE",payload:d}),a&&d.pageState?.lastVisitedPath&&(a(d.pageState.lastVisitedPath),d.pageState.scrollPositions&&setTimeout(()=>{let a=d.pageState?.scrollPositions?.[d.pageState.lastVisitedPath||""];"number"==typeof a&&window.scrollTo(0,a)},100));let e=localStorage.getItem("activeSessionId");e&&!d.chatContext?.currentConversationId&&c({type:"SET_CHAT_CONTEXT",payload:{...d.chatContext,currentConversationId:e}}),n(!0)}catch(a){console.error("Error hydrating state:",a),n(!0)}finally{l(!1)}},[]);return(0,e.useRef)(null),(0,e.useRef)(0),(0,d.jsx)(j.Provider,{value:{state:b,dispatch:c,isStateLoading:k,isStateHydrated:m,isStateRecovered:o,isStateSyncing:q,hydrateFromStorage:v},children:a})}function l(){let a=(0,e.useContext)(j);if(void 0===a)throw Error("useAppState must be used within an AppStateProvider");return a}},7856:(a,b,c)=>{"use strict";c.d(b,{A:()=>g});var d=c(8732),e=c(2015);class f extends e.Component{constructor(a){super(a),this.state={hasError:!1,error:null}}static getDerivedStateFromError(a){return{hasError:!0,error:a}}componentDidCatch(a,b){console.error(`Error in component ${this.props.componentName||"unknown"}:`,a,b),this.props.onError&&this.props.onError(a,b)}render(){return this.state.hasError?this.props.fallback?this.props.fallback:(0,d.jsxs)("div",{className:"error-boundary p-4 m-2 bg-red-100 border border-red-400 text-red-700 rounded",children:[(0,d.jsxs)("h3",{className:"font-bold",children:["Something went wrong in ",this.props.componentName||"this component"]}),(0,d.jsxs)("details",{className:"whitespace-pre-wrap text-sm mt-2",children:[(0,d.jsx)("summary",{children:"View error details"}),(0,d.jsx)("p",{className:"mt-1",children:this.state.error?.toString()})]})]}):this.props.children}}let g=f},9104:(a,b,c)=>{"use strict";c.d(b,{O:()=>k});let d=[],e=null,f=!1,g=null;function h(){if(0!==d.length){var a=d.splice(0,25);try{let b=function(){let a=(process.env||{}).NEXT_PUBLIC_API_URL||"";return a?a.replace(/\/$/,""):""}(),c=b?`${b}/api/logs`:"/api/logs";fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({entries:a}),keepalive:!0}).catch(()=>{})}catch{}}}function i(a){try{a.msg&&a.msg.length>1e4&&(a.msg=a.msg.slice(0,1e4)+"â€¦"),d.push(a),d.length>=25?h():function a(){null==e&&(e=setTimeout(()=>{e=null,h(),d.length>0&&a()},3e3))}()}catch{}}function j(a,b,c,d){return{lvl:a,msg:b,ts:new Date().toISOString(),route:function(){try{return window.location?.pathname+window.location?.search}catch{return}}(),userId:null,sessionId:g,stack:d,context:c,ua:function(){try{return navigator.userAgent}catch{return}}()}}function k(a){if(!f){f=!0,function(){if(!g)try{let a="GRACE_CLIENT_SID",b=sessionStorage.getItem(a);if(b){g=b;return}let c=Math.random().toString(36).slice(2)+Date.now().toString(36);sessionStorage.setItem(a,c),g=c}catch{}}();try{let a=window.onerror;window.onerror=function(b,c,d,e,f){let g=f&&f.stack||void 0;return i(j("error",String(b),{source:c,lineno:d,colno:e},g)),"function"==typeof a&&a(b,c,d,e,f)}}catch{}try{window.addEventListener("unhandledrejection",a=>{let b=a?.reason,c="string"==typeof b?b:b?.message||"Unhandled promise rejection",d=b?.stack;i(j("error",c,{type:"unhandledrejection"},d))})}catch{}["log","info","warn","error"].forEach(a=>{try{let b=console[a];console[a]=(...c)=>{try{let b=c.map(a=>{if("string"==typeof a)return a;try{return JSON.stringify(a)}catch{return String(a)}}).join(" ");i(j(a,b))}catch{}try{b.apply(console,c)}catch{}}}catch{}});try{let a=window.fetch.bind(window);window.fetch=async(b,c)=>{let d=performance.now(),e="";try{e="string"==typeof b?b:b?.url||""}catch{}try{let f=await a(b,c),g=Math.round(performance.now()-d);return f.ok||i(j("warn","fetch-fail",{url:e,status:f.status,statusText:f.statusText,durationMs:g})),f}catch(b){let a=Math.round(performance.now()-d);throw i(j("error","fetch-error",{url:e,durationMs:a,error:b?.message||String(b)},b?.stack)),b}}}catch{}try{window.addEventListener("visibilitychange",()=>{i(j("info","visibility:"+document.visibilityState))}),window.addEventListener("pageshow",()=>i(j("info","pageshow"))),window.addEventListener("pagehide",()=>i(j("info","pagehide"))),window.addEventListener("popstate",()=>i(j("info","popstate"))),window.addEventListener("focus",()=>i(j("info","focus"))),window.addEventListener("blur",()=>i(j("info","blur"))),window.addEventListener("resize",()=>{try{i(j("info","resize",{w:window.innerWidth,h:window.innerHeight}))}catch{i(j("info","resize"))}})}catch{}try{window.addEventListener("beforeunload",()=>{h()})}catch{}try{let b=a?.events;b&&"function"==typeof b.on&&(b.on("routeChangeStart",a=>i(j("info","routeChangeStart",{url:a}))),b.on("routeChangeComplete",a=>i(j("info","routeChangeComplete",{url:a}))),b.on("hashChangeStart",a=>i(j("info","hashChangeStart",{url:a}))),b.on("hashChangeComplete",a=>i(j("info","hashChangeComplete",{url:a}))))}catch{}try{if("PerformanceObserver"in window){try{new PerformanceObserver(a=>{for(let b of a.getEntries()){if(b&&b.hadRecentInput)continue;let a={value:b?.value,startTime:Math.round(b?.startTime||0),sources:Array.isArray(b?.sources)?b.sources.map(a=>a?.node?.tagName||a?.id||"node"):void 0};i(j("warn","layout-shift",a))}}).observe({type:"layout-shift",buffered:!0})}catch{}try{new PerformanceObserver(a=>{for(let b of a.getEntries()){let a={durationMs:Math.round(b?.duration||0),startTime:Math.round(b?.startTime||0),name:b?.name};(b?.duration||0)>=50&&i(j("warn","longtask",a))}}).observe({type:"longtask",buffered:!0})}catch{}}}catch{}}}},9319:()=>{},9803:()=>{}};
"use strict";exports.id=160,exports.ids=[160],exports.modules={2160:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{A:()=>n,U:()=>l});var e=c(8732),f=c(2015),g=c(3777),h=c(4049),i=c(4391),j=a([i]);i=(j.then?(await j)():j)[0];class k{listeners={};on(a,b){this.listeners[a]||(this.listeners[a]=[]),this.listeners[a].push(b)}emit(a,b){this.listeners[a]&&this.listeners[a].forEach(a=>a(b))}off(a,b){this.listeners[a]&&(this.listeners[a]=this.listeners[a].filter(a=>a!==b))}clear(a){this.listeners[a]=[]}}let l=new k,m=({position:a,onClose:b})=>{let c="leverage"===a.type,d="unrealizedPnl"in a&&a.unrealizedPnl||0,g=a.entryPrice>0?(a.currentPrice-a.entryPrice)/a.entryPrice*100:0,h="openTimestamp"in a?"string"==typeof a.openTimestamp?new Date(a.openTimestamp).getTime():a.openTimestamp:Date.now(),[i,j]=(0,f.useState)(!1),[k,m]=(0,f.useState)(100),[n,o]=(0,f.useState)(!1),p=async()=>{try{o(!0),await b(a.id,k)&&(l.emit("positionClosed",{positionId:a.id,percentage:k}),j(!1),m(100))}catch(a){console.error("Error closing position:",a)}finally{o(!1)}},q=(a.amount*k/100).toFixed(4),r=(a.currentPrice*a.amount*k/100).toFixed(2);return(0,e.jsxs)("div",{className:"bg-gray-900 rounded-lg p-4 mb-3 border-l-4 border-red-500 border border-gray-700",children:[(0,e.jsxs)("div",{className:"flex justify-between items-start",children:[(0,e.jsxs)("div",{children:[(0,e.jsx)("h4",{className:"font-medium text-white",children:a.token}),(0,e.jsxs)("div",{className:"text-sm text-gray-400",children:[a.amount.toFixed(4)," @ $",a.entryPrice.toFixed(2)]}),c&&"leverage"in a&&(0,e.jsxs)("div",{className:"text-xs text-yellow-400 mt-1",children:["Leverage: ",a.leverage,"x"]}),(0,e.jsx)("div",{className:"text-xs text-gray-500 mt-1",children:new Date(h).toLocaleString()})]}),(0,e.jsxs)("div",{className:"text-right",children:[(0,e.jsxs)("div",{className:`text-sm font-medium ${d>=0?"text-green-400":"text-red-400"}`,children:["$",d.toFixed(2)," (",g.toFixed(2),"%)"]}),(0,e.jsxs)("div",{className:"text-xs text-gray-400",children:["$",(a.amount*a.currentPrice).toFixed(2)]}),(0,e.jsxs)("div",{className:"text-xs text-gray-500",children:["Current: $",a.currentPrice.toFixed(2)]})]})]}),i?(0,e.jsxs)("div",{className:"mt-3 border-t border-gray-700 pt-2",children:[(0,e.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,e.jsxs)("div",{className:"text-sm text-gray-300",children:["Close: ",(0,e.jsxs)("span",{className:"font-medium",children:[k,"%"]}),(0,e.jsxs)("span",{className:"text-xs text-gray-400 ml-1",children:["(",q," ",a.token," â‰ˆ $",r,")"]})]}),(0,e.jsx)("button",{onClick:()=>j(!1),className:"text-xs text-gray-400 hover:text-white",children:"Cancel"})]}),(0,e.jsxs)("div",{className:"mb-3",children:[(0,e.jsx)("input",{type:"range",min:"1",max:"100",value:k,onChange:a=>m(parseInt(a.target.value)),className:"w-full"}),(0,e.jsxs)("div",{className:"flex justify-between text-xs text-gray-500",children:[(0,e.jsx)("span",{children:"1%"}),(0,e.jsx)("span",{children:"25%"}),(0,e.jsx)("span",{children:"50%"}),(0,e.jsx)("span",{children:"75%"}),(0,e.jsx)("span",{children:"100%"})]})]}),(0,e.jsx)("div",{className:"flex justify-end space-x-2",children:(0,e.jsxs)("button",{onClick:p,disabled:n,className:`text-xs ${n?"bg-gray-600":"bg-red-600 hover:bg-red-700"} text-white px-3 py-1 rounded flex items-center`,children:[n&&(0,e.jsxs)("svg",{className:"animate-spin -ml-1 mr-2 h-3 w-3 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,e.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,e.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),n?"Processing...":"Confirm Close"]})})]}):(0,e.jsx)("div",{className:"mt-3 flex justify-end space-x-2",children:(0,e.jsx)("button",{onClick:()=>j(!0),className:"text-xs bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded",children:"Close Position"})})]})},n=({initialExpanded:a=!1,onToggleExpand:b,refreshInterval:c=3e4})=>{let{user:d}=(0,g.A)(),[j,k]=(0,f.useState)([]),[n,o]=(0,f.useState)([]),[p,q]=(0,f.useState)(a),[r,s]=(0,f.useState)(!0),[t,u]=(0,f.useState)(null),[v,w]=(0,f.useState)(null),x=(0,f.useRef)(!0),y=(0,f.useRef)(),z=(0,f.useRef)(),A=(0,f.useCallback)(async(a=!1)=>{if(!d?.token)return void u("Authentication required");a||s(!0);try{let{data:a,success:b,error:c}=await h.FH.get(h.Sn.WALLET.TRANSACTIONS,{headers:{Authorization:`Bearer ${d.token}`}});if(b&&a)o(Array.isArray(a)?a:[]);else throw Error(c||"Failed to fetch transactions")}catch(c){let b=c instanceof Error?c.message:"Failed to fetch transactions";throw console.error("Error fetching transactions:",c),a||(i.toast.error(b),setTimeout(()=>A(!0),5e3)),c}finally{a||s(!1)}},[d?.token]);(0,f.useCallback)(a=>{try{if(!(a=>"object"==typeof a&&null!==a&&"string"==typeof a.id&&"string"==typeof a.token&&("spot"===a.type||"leverage"===a.type)&&"number"==typeof a.amount&&"number"==typeof a.entryPrice&&"number"==typeof a.currentPrice&&"number"==typeof a.openTimestamp)(a))return void console.warn("Invalid trade data",a);let b=a.entryPrice||0,c=a.currentPrice||b,d=a.amount||0,e={...a,id:a.id||`trade_${Date.now()}`,token:a.token||"UNKNOWN",type:a.type||"spot",amount:d,entryPrice:b,currentPrice:c,openTimestamp:a.openTimestamp?.toString()||new Date().toISOString(),timestamp:a.timestamp||new Date().toISOString(),currentValue:d*c,profitLoss:b?(c-b)/b*100:0},f={id:e.id,type:"leverage"===e.type?"buy":"swap",token:e.token,amount:e.amount,timestamp:e.openTimestamp,status:"completed"};k(a=>[...a,e]),o(a=>[f,...a]),A().catch(a=>{console.error("Error refreshing transactions:",a)})}catch(a){console.error("Error tracking new trade:",a),i.toast.error("Failed to track new trade")}},[A]);let B=(0,f.useCallback)(async(a=!1)=>{if(d){a||(s(!0),u(null));try{let a={positions:[]},b={positions:[]};try{a=await h.S1.getUserSpotPositions(),l.emit("walletPositionsUpdated",{type:"spot",count:a.positions.length,timestamp:new Date().toISOString()})}catch(a){console.error("Error fetching spot positions:",a)}try{b=await h.S1.getUserLeveragePositions(),l.emit("walletPositionsUpdated",{type:"leverage",count:b.positions.length,timestamp:new Date().toISOString()})}catch(a){console.error("Error fetching leverage positions:",a)}if(!x.current)return;let c=a=>{let b={id:a.id,token:a.token,type:a.type,amount:a.amount,entryPrice:a.entryPrice,currentPrice:a.currentPrice||0,currentValue:a.amount*(a.currentPrice||0),profitLoss:a.unrealizedPnl||0,openTimestamp:new Date(a.openTimestamp||Date.now()).toISOString(),side:a.side,market:a.market,timestamp:a.timestamp,unrealizedPnl:a.unrealizedPnl,realizedPnl:a.realizedPnl};return"leverage"===a.type?{...b,leverage:a.leverage||1,liquidationPrice:a.liquidationPrice||0,marginRatio:a.marginRatio||0}:b},d=[...(a.positions||[]).map(c),...(b.positions||[]).map(c)];k(d),w(new Date)}catch(b){if(console.error("Error fetching positions:",b),k([]),!a){let a=b instanceof Error?b.message:"Failed to fetch positions";u(a),setTimeout(()=>B(!0),5e3)}throw b}finally{a||s(!1)}}},[d?.token]);(0,f.useEffect)(()=>{B()},[d]),(0,f.useEffect)(()=>{let a=a=>{console.log("Trade confirmed, refreshing positions:",a),B().catch(a=>{console.error("Error refreshing positions after trade confirmation:",a)})};return l.on("trade:confirmed",a),()=>{l.off("trade:confirmed",a)}},[B]),(0,f.useEffect)(()=>((async()=>{try{await Promise.all([B().catch(a=>console.log("Positions not available yet: waiting for auth")),A().catch(a=>console.log("Transactions not available yet: waiting for auth"))])}catch(a){console.error("Initial fetch failed:",a)}})(),y.current=setInterval(()=>{B().catch(console.error)},c),z.current=setInterval(()=>{A().catch(console.error)},2*c),()=>{y.current&&clearInterval(y.current),z.current&&clearInterval(z.current)}),[d,c,B,A]),(0,f.useEffect)(()=>()=>{x.current=!1,y.current&&clearInterval(y.current),z.current&&clearInterval(z.current)},[]),(0,f.useCallback)(async a=>{if(!d)return i.toast.error("Authentication required to close positions"),!1;let b=j.find(b=>b.id===a);if(!b)return i.toast.error("Position not found"),!1;if(!window.confirm(`Are you sure you want to close this ${b.token} position?`))return!1;try{s(!0);let c=await h.S1.sellPosition({positionId:a,token:b.token,amount:b.amount,type:b.type});if(c.success)return k(b=>b.filter(b=>b.id!==a)),l.emit("positionSold",{...b,timestamp:new Date().toISOString(),wallet_affected:!0,transaction_type:"position_close"}),await Promise.all([B(),A()]),i.toast.success(c.message||`Successfully closed ${b.token} position`),!0;throw Error(c.error||"Failed to close position")}catch(a){return console.error("Error selling position",a),i.toast.error(a instanceof Error?a.message:"Failed to close position"),!1}},[d?.token,j,s,B,A,l]),(0,f.useMemo)(()=>{let a=j.reduce((a,b)=>a+b.currentValue,0),b=j.reduce((a,b)=>a+b.profitLoss,0),c=j.filter(a=>a.profitLoss>0).length;return{totalValue:a,totalPnl:b,winRate:j.length>0?c/j.length*100:0,totalPositions:j.length,lastUpdated:v}},[j,v]);let C=(0,f.useCallback)(async(a,b)=>{if(!d?.token)return i.toast.error("Authentication required to close positions"),!1;let c=j.find(b=>b.id===a);if(!c)return i.toast.error("Position not found"),!1;let e=b&&b>0&&b<100,f=e?c.amount*b/100:c.amount;try{s(!0);let d=await h.S1.sellPosition({positionId:a,token:c.token,amount:c.amount,type:c.type,percentage:b});if(d.success){e?k(b=>b.map(b=>b.id===a?{...b,amount:b.amount-f}:b)):k(b=>b.filter(b=>b.id!==a)),l.emit("positionSold",{...c,amount:f,percentage:b||100,isPartial:e,timestamp:new Date().toISOString()}),await Promise.all([B(),A()]);let g=e?`Successfully closed ${b}% of ${c.token} position`:`Successfully closed ${c.token} position`;return i.toast.success(d.message||g),!0}throw Error(d.error||"Failed to close position")}catch(b){let a=b instanceof Error?b.message:"Failed to close position";return console.error("Error closing position:",b),i.toast.error(`Error: ${a}`),!1}finally{s(!1)}},[d?.token,j,B,A]);return(0,e.jsxs)("div",{className:"bg-gray-800 shadow-md rounded-lg p-4 border border-gray-700",children:[(0,e.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,e.jsx)("h2",{className:"text-lg font-semibold text-red-300",children:"Public Trading Positions"}),(0,e.jsx)("button",{onClick:()=>{q(!p)},className:"text-red-400 hover:text-red-300 text-sm bg-red-900/30 px-2 py-1 rounded border border-red-800",children:p?"Collapse":"Expand"})]}),d?r?(0,e.jsxs)("div",{className:"text-center py-4 border border-gray-700 rounded bg-gray-900/50 p-4",children:[(0,e.jsx)("p",{className:"text-gray-300 mb-2",children:"Loading positions..."}),(0,e.jsx)("div",{className:"flex justify-center mt-2",children:(0,e.jsx)("div",{className:"animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-red-500"})})]}):0===j.length?(0,e.jsxs)("div",{className:"text-center py-4 border border-gray-700 rounded bg-gray-900/50 p-4",children:[(0,e.jsx)("p",{className:"text-gray-300 mb-2",children:"No trading positions available"}),(0,e.jsx)("p",{className:"text-sm text-gray-400",children:"Your active trades will appear here"})]}):(0,e.jsx)("div",{className:"overflow-hidden",children:j.map(a=>(0,e.jsx)(m,{position:a,onClose:C},a.id))}):(0,e.jsxs)("div",{className:"text-center py-4 border border-gray-700 rounded bg-gray-900/50 p-4",children:[(0,e.jsx)("p",{className:"text-gray-300 mb-2",children:"Trading Widget"}),(0,e.jsx)("p",{className:"text-sm text-gray-400",children:"Log in to view your trading positions"})]})]})};d()}catch(a){d(a)}})}};
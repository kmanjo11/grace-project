(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[106],{5210:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>j});var a=s(7765),n=s(5977),r=s(8840),l=s(25);let i=function(e,t,s){var a,r,i,o,c,d,u,m,g,h;let f=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",{state:x,dispatch:p}=(0,l.A)(),v="1"==="1".toString()||"true"==="1".toString().toLowerCase(),y=(0,n.useRef)(""),b=(0,n.useRef)(""),w=(0,n.useRef)(""),S=(0,n.useCallback)(()=>{var e;if((null==(e=x.chatState)?void 0:e.sessions)&&Object.keys(x.chatState.sessions).length>0)return Object.values(x.chatState.sessions||{}).map(e=>({id:e.id||e.session_id||"",session_id:e.session_id||e.id||"",name:e.name||e.topic||"Chat ".concat((e.session_id||e.id||"").slice(0,6)),topic:e.topic||e.name||"",lastActivity:e.updated_at||new Date().toISOString(),messages:Array.isArray(e.messages)?e.messages.map(e=>({sender:"user"===e.role?"user":"grace",text:e.content||"",timestamp:e.timestamp||new Date().toISOString(),user:"user"===e.role?e.content:void 0,bot:"assistant"===e.role?e.content:void 0})):[],scrollPosition:e.scrollPosition,unread_count:e.unread_count||0}));if(v)return[];let t=localStorage.getItem("activeSessionId");if(t)try{let e=N(t);if(e.length>0)return[{id:t,session_id:t,name:"Chat ".concat(t.slice(0,6)),topic:"Chat ".concat(t.slice(0,6)),lastActivity:localStorage.getItem("lastSynced_".concat(t))||new Date().toISOString(),messages:e}]}catch(e){console.error("Error loading sessions from cache:",e)}return[]},[null==(a=x.chatState)?void 0:a.sessions,v]),N=(0,n.useCallback)(e=>{if(!e)return[];try{var t,s,a;let n=null==(a=x.chatState)||null==(s=a.sessions)||null==(t=s[e])?void 0:t.messages;if(Array.isArray(n)&&n.length>0)return console.log("Restoring ".concat(n.length," messages from global state for session ").concat(e)),n.map(e=>({sender:"user"===e.role?"user":"grace",text:e.content||"",timestamp:e.timestamp||new Date().toISOString(),user:"user"===e.role?e.content:void 0,bot:"assistant"===e.role?e.content:void 0}));if(v)return[];let r=localStorage.getItem("messages_".concat(e));if(r){let t=JSON.parse(r);if(Array.isArray(t)&&t.length>0)return console.log("Restoring ".concat(t.length," messages from localStorage for session ").concat(e)),t}}catch(e){console.error("Error loading messages from cache:",e)}return[]},[null==(r=x.chatState)?void 0:r.sessions,v]);(0,n.useEffect)(()=>{let e=S();e.length>0&&0===t.length&&console.log("Chat sessions available in persistent state",e)},[S,t.length]),(0,n.useEffect)(()=>{var s,a;if(!e||0===t.length)return;let n=t.reduce((e,t)=>{let s=t.session_id||t.id;if(s){var a,n;let r=null==(n=x.chatState)||null==(a=n.sessions)?void 0:a[s];e[s]={id:t.id,session_id:t.session_id||t.id,topic:t.topic||t.name,name:t.name,created_at:t.created_at||t.lastActivity,updated_at:(null==r?void 0:r.updated_at)||t.updated_at||t.lastActivity,preview_message:t.messages&&t.messages.length>0?t.messages[t.messages.length-1].text||t.messages[t.messages.length-1].user||t.messages[t.messages.length-1].bot:"",messages:(null==r?void 0:r.messages)||[],scrollPosition:t.scrollPosition,unread_count:t.unread_count||0}}return e},{}),r=JSON.stringify(n);t.map(e=>e.session_id||e.id).join("|");let l=f||"";(y.current!==r||w.current!==l||(null==(s=x.chatState)?void 0:s.currentSessionId)!==e)&&(y.current=r,w.current=l,p({type:"SET_CHAT_STATE",payload:{activeSessions:t.map(e=>e.session_id||e.id),currentSessionId:e,sessions:n,draftMessages:{...(null==(a=x.chatState)?void 0:a.draftMessages)||{},[e]:f}}}));let i=t.find(t=>t.id===e||t.session_id===e);!v&&i&&Array.isArray(i.messages)&&i.messages.length>0&&j(e,i.messages)},[e,t,f,null==(i=x.chatState)?void 0:i.sessions,null==(o=x.chatState)?void 0:o.currentSessionId,p]),(0,n.useEffect)(()=>{var t;if(!e||0===s.length||!(null==(t=x.chatState)?void 0:t.sessions))return;let a=x.chatState.sessions[e],n=JSON.stringify(s);a&&b.current!==n&&(b.current=n,p({type:"SET_CHAT_STATE",payload:{sessions:{...x.chatState.sessions,[e]:{...a,messages:s,updated_at:new Date().toISOString()}}}}))},[e,s,null==(c=x.chatState)?void 0:c.sessions,p]);let j=(0,n.useCallback)((e,t)=>{if(e&&t&&0!==t.length)try{console.log("Persisting ".concat(t.length," messages for session ").concat(e));let s=t.slice(-100);v||(localStorage.setItem("messages_".concat(e),JSON.stringify(s)),localStorage.setItem("lastSynced_".concat(e),new Date().toISOString()),localStorage.setItem("activeSessionId",e))}catch(e){console.error("Failed to store messages:",e)}},[v]);return{initializeFromPersistedState:(0,n.useCallback)((e,s)=>{let a=S();if(a.length>0&&0===t.length){var n,r;e(a);let t=v?null:localStorage.getItem("activeSessionId");return s(t?a.some(e=>e.session_id===t||e.id===t)?t:(null==(r=x.chatState)?void 0:r.currentSessionId)?x.chatState.currentSessionId:a[0].session_id||a[0].id:(null==(n=x.chatState)?void 0:n.currentSessionId)?x.chatState.currentSessionId:a[0].session_id||a[0].id),!0}return!1},[S,t.length,null==(d=x.chatState)?void 0:d.currentSessionId,v]),getStoredSessions:S,loadMessagesFromCache:N,persistMessages:j,syncScrollPosition:(0,n.useCallback)(t=>{var s,a,n;e&&(v||localStorage.setItem("scrollPosition_".concat(e),t.toString()),p({type:"SET_CHAT_STATE",payload:{sessions:{...(null==(s=x.chatState)?void 0:s.sessions)||{},[e]:{...(null==(n=x.chatState)||null==(a=n.sessions)?void 0:a[e])||{},scrollPosition:t}}}}))},[e,null==(u=x.chatState)?void 0:u.sessions,p,v]),getSavedScrollPosition:(0,n.useCallback)(()=>{var t,s;if(!e)return null;let a=v?null:localStorage.getItem("scrollPosition_".concat(e));return a?parseInt(a,10):(null==(s=x.chatState)||null==(t=s.sessions)?void 0:t[e])?x.chatState.sessions[e].scrollPosition:null},[e,null==(m=x.chatState)?void 0:m.sessions,v]),getSavedDraftMessage:(0,n.useCallback)(()=>{var t;if(!e)return"";let s=v?null:localStorage.getItem("draft_".concat(e));return s||(null==(t=x.chatState)?void 0:t.draftMessages)&&e in x.chatState.draftMessages&&x.chatState.draftMessages[e]||""},[e,null==(g=x.chatState)?void 0:g.draftMessages,v]),updateDraftMessage:(0,n.useCallback)(t=>{var s,a,n;e&&((null==(a=x.chatState)||null==(s=a.draftMessages)?void 0:s[e])||"")!==t&&(v||localStorage.setItem("draft_".concat(e),t),p({type:"SET_CHAT_STATE",payload:{draftMessages:{...(null==(n=x.chatState)?void 0:n.draftMessages)||{},[e]:t}}}))},[e,null==(h=x.chatState)?void 0:h.draftMessages,p,v])}};var o=s(5329),c=s(7760),d=s(5491),u=s(1735),m=s(8231),g=s(2281),h=s(8388),f=s(41),x=s(9317);let p=e=>{var t;let{maxItems:s=5}=e,{state:r,dispatch:i}=(0,l.A)(),[p,v]=(0,n.useState)([]),[y,b]=(0,n.useState)(!1),[w,S]=(0,n.useState)(null),[N,j]=(0,n.useState)(!1),[_,C]=(0,n.useState)(""),A=(null==(t=r.xfeed)?void 0:t.followedAccounts)||[];(0,n.useEffect)(()=>{A.length>0&&I()},[A]);let I=async()=>{if(0!==A.length){b(!0),S(null);try{let e=A.map(e=>{let t="from:".concat(e.replace("@",""));return console.log("Fetching tweets for ".concat(e," with query: ").concat(t)),x.A.get("/api/social/tweets",{params:{query:t,search_type:"tweets",count:Math.ceil(s/A.length),include_media:!0}})}),t=await Promise.all(e),a=[];t.forEach((e,t)=>{let s=e.data.data||{};if(s.results&&Array.isArray(s.results)){let e=s.results.map(e=>{var s,a,n;return{id:e.id,text:e.text,created_at:e.created_at,username:(null==(s=e.user)?void 0:s.username)||A[t],name:(null==(a=e.user)?void 0:a.name)||A[t],profile_image_url:null==(n=e.user)?void 0:n.profile_image_url,media:e.media,heat_score:E(e),likes_count:e.likes_count||0,retweets_count:e.retweets_count||0}});a=[...a,...e]}}),a.sort((e,t)=>new Date(t.created_at).getTime()-new Date(e.created_at).getTime()),v(a.slice(0,s))}catch(e){console.error("Error fetching tweets:",e),S("Failed to load tweets. Please try again later.")}finally{b(!1)}}},E=e=>{let t=e.likes_count||0,s=e.retweets_count||0,a=new Date(e.created_at),n=(new Date().getTime()-a.getTime())/36e5;return Math.min(100,Math.round((+t+2*s+100*(n<24?(24-n)/24:0)*3)/10))};return(0,a.jsxs)("div",{className:"p-4 h-full flex flex-col overflow-hidden bg-white rounded-md shadow",children:[(0,a.jsxs)("div",{className:"flex items-center mb-4",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold flex-grow",children:"X Feed"}),(0,a.jsxs)("div",{className:"flex space-x-2",children:[(0,a.jsx)("button",{className:"p-1 rounded-full hover:bg-gray-100 transition-colors ".concat(y?"opacity-50 cursor-not-allowed":""),onClick:I,disabled:y,"aria-label":"Refresh feed",children:(0,a.jsx)(o.A,{className:"h-5 w-5"})}),(0,a.jsx)("button",{className:"p-1 rounded-full hover:bg-gray-100 transition-colors",onClick:()=>j(!0),"aria-label":"Feed settings",children:(0,a.jsx)(c.A,{className:"h-5 w-5"})})]})]}),(0,a.jsx)("div",{className:"overflow-auto flex-1",children:0===A.length?(0,a.jsxs)("div",{className:"p-4 text-center",children:[(0,a.jsx)("p",{className:"text-base text-gray-600",children:"No accounts followed"}),(0,a.jsxs)("button",{className:"mt-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-sm flex items-center mx-auto",onClick:()=>j(!0),children:[(0,a.jsx)(d.A,{className:"h-4 w-4 mr-1"}),"Add Accounts"]})]}):y?(0,a.jsx)("div",{className:"flex justify-center p-6",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"})}):w?(0,a.jsx)("div",{className:"p-4 text-center",children:(0,a.jsx)("p",{className:"text-base text-red-600",children:w})}):0===p.length?(0,a.jsx)("div",{className:"p-4 text-center",children:(0,a.jsx)("p",{className:"text-base text-gray-600",children:"No tweets found"})}):p.map(e=>(0,a.jsx)("div",{className:"mb-4 p-3 bg-white rounded-lg border border-gray-200 hover:shadow-md transition-shadow",children:(0,a.jsxs)("div",{className:"flex",children:[(0,a.jsx)("div",{className:"mr-3",children:e.profile_image_url?(0,a.jsx)("img",{src:e.profile_image_url,alt:e.name,className:"w-10 h-10 rounded-full"}):(0,a.jsx)("div",{className:"w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-semibold",children:e.username.charAt(0).toUpperCase()})}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("span",{className:"font-semibold text-sm",children:e.name}),(0,a.jsxs)("span",{className:"ml-1 text-xs text-gray-500",children:["@",e.username]}),(0,a.jsx)("span",{className:"ml-auto text-xs text-gray-500",children:(e=>{try{let t=new Date(e),s=new Date().getTime()-t.getTime(),a=Math.floor(s/864e5);if(0===a){let e=Math.floor(s/36e5);if(0===e){let e=Math.floor(s/6e4);return"".concat(e," min").concat(1!==e?"s":""," ago")}return"".concat(e," hour").concat(1!==e?"s":""," ago")}if(1===a)return"Yesterday";if(a<7)return"".concat(a," days ago");else return t.toLocaleDateString()}catch(t){return e}})(e.created_at)})]}),(0,a.jsx)("div",{className:"mt-1 text-sm",children:e.text}),e.media&&e.media.length>0&&"photo"===e.media[0].type&&(0,a.jsx)("div",{className:"mt-2",children:(0,a.jsx)("img",{src:e.media[0].url,alt:"Tweet media",className:"max-h-[150px] object-contain rounded"})}),(0,a.jsxs)("div",{className:"flex mt-2 text-xs text-gray-500 space-x-4",children:[(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)(u.A,{className:"h-3 w-3 mr-1"}),e.likes_count]}),(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)(m.A,{className:"h-3 w-3 mr-1"}),e.retweets_count]}),void 0!==e.heat_score&&(0,a.jsxs)("div",{className:"ml-auto px-1.5 py-0.5 rounded text-white text-xs ".concat(e.heat_score>80?"bg-red-500":e.heat_score>50?"bg-yellow-500":"bg-blue-500"),children:[e.heat_score,"\xb0"]})]})]})]})},e.id))}),(0,a.jsx)(h.e,{appear:!0,show:N,as:n.Fragment,children:(0,a.jsxs)(f.lG,{as:"div",className:"relative z-10",onClose:()=>j(!1),children:[(0,a.jsx)(h.e.Child,{as:n.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-25"})}),(0,a.jsx)("div",{className:"fixed inset-0 overflow-y-auto",children:(0,a.jsx)("div",{className:"flex min-h-full items-center justify-center p-4 text-center",children:(0,a.jsx)(h.e.Child,{as:n.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",children:(0,a.jsxs)(f.lG.Panel,{className:"w-full max-w-md transform overflow-hidden rounded-2xl bg-white p-6 text-left align-middle shadow-xl transition-all",children:[(0,a.jsx)(f.lG.Title,{as:"h3",className:"text-lg font-medium leading-6 text-gray-900",children:"X Feed Settings"}),(0,a.jsxs)("div",{className:"mt-4",children:[(0,a.jsx)("h4",{className:"text-sm font-medium text-gray-700",children:"Add X accounts to follow"}),(0,a.jsxs)("div",{className:"mt-2 flex",children:[(0,a.jsx)("input",{type:"text",className:"flex-grow rounded-md border border-gray-300 px-3 py-1.5 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500",placeholder:"@username",value:_,onChange:e=>C(e.target.value)}),(0,a.jsx)("button",{type:"button",className:"ml-2 rounded-md bg-blue-600 px-3.5 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 ".concat(_.trim()?"":"opacity-50 cursor-not-allowed"),onClick:()=>{if(!_.trim())return;let e=_.trim();if(e.startsWith("@")&&(e=e.substring(1)),e=e.replace(/[^a-zA-Z0-9_]/g,"")){if(A.includes(e))return void C("");i({type:"UPDATE_XFEED",payload:{followedAccounts:[...A,e]}}),C(""),0===A.length&&I()}},disabled:!_.trim(),children:"Add"})]})]}),(0,a.jsx)("div",{className:"mt-4",children:(0,a.jsxs)("div",{className:"border-t border-gray-200 pt-4",children:[(0,a.jsx)("h4",{className:"text-sm font-medium text-gray-700",children:"Followed Accounts"}),0===A.length?(0,a.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"No accounts added yet"}):(0,a.jsx)("ul",{className:"mt-2 space-y-2",children:A.map(e=>(0,a.jsxs)("li",{className:"flex items-center justify-between",children:[(0,a.jsxs)("span",{className:"text-sm",children:["@",e]}),(0,a.jsx)("button",{type:"button",onClick:()=>{i({type:"UPDATE_XFEED",payload:{followedAccounts:A.filter(t=>t!==e)}})},className:"rounded-full p-1 text-gray-400 hover:text-red-600 hover:bg-red-50",children:(0,a.jsx)(g.A,{className:"h-4 w-4"})})]},e))})]})}),(0,a.jsx)("div",{className:"mt-6 flex justify-end",children:(0,a.jsx)("button",{type:"button",className:"rounded-md bg-gray-100 px-3.5 py-1.5 text-sm font-semibold text-gray-900 shadow-sm hover:bg-gray-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-600",onClick:()=>j(!1),children:"Close"})})]})})})})]})})]})};var v=s(1396),y=s(5327),b=s(9311),w=s(7650);let S=["chat","sessions"],N=e=>["chat","messages",e];function j(){let{isAuthenticated:e,user:t}=(0,r.A)(),s="1"==="1".toString()||"true"==="1".toString().toLowerCase(),[l,o]=(0,n.useState)([]),[c,d]=(0,n.useState)(null),[u,m]=(0,n.useState)([]),[g,h]=(0,n.useState)(""),[f,x]=(0,n.useState)(""),{sessions:j,create:_,rename:C,isLoading:A}=function(){let e=(0,v.jE)(),t=(0,y.I)({queryKey:S,queryFn:async()=>{let{sessions:e}=await w.rh.getSessions(),t=e.map(e=>{var t,s,a,n,r,l,i,o,c,d;return{id:null!=(t=e.id)?t:e.session_id,session_id:null!=(s=e.session_id)?s:e.id,name:null!=(r=null!=(n=null!=(a=e.title)?a:e.name)?n:e.topic)?r:"New Conversation",topic:null!=(o=null!=(i=null!=(l=e.topic)?l:e.title)?i:e.name)?o:"New Conversation",lastActivity:null!=(d=null!=(c=e.updated)?c:e.lastActivity)?d:new Date().toISOString(),message_count:e.message_count,metadata:e.metadata}});return t.sort((e,t)=>new Date(t.lastActivity||"").getTime()-new Date(e.lastActivity||"").getTime()),t},staleTime:3e4}),s=(0,b.n)({mutationFn:async e=>w.rh.createSession(e),onMutate:async t=>{let s="temp_".concat(Date.now()),a=new Date().toISOString(),n=e.getQueryData(S)||[];return e.setQueryData(S,[{id:s,session_id:s,name:t||"New Conversation",topic:t||"New Conversation",lastActivity:a},...n]),{prev:n,tempId:s}},onError:(t,s,a)=>{a&&e.setQueryData(S,a.prev)},onSuccess:async(t,s,a)=>{let{session_id:n}=t;return e.setQueryData(S,e=>e?e.map(e=>e.id===(null==a?void 0:a.tempId)||e.session_id===(null==a?void 0:a.tempId)?{...e,id:n,session_id:n}:e):e),await e.invalidateQueries({queryKey:S}),n}}),a=async(t,s)=>{e.setQueryData(S,e=>e?e.map(e=>e.session_id===t||e.id===t?{...e,name:s,topic:s}:e):e)};return{sessions:t.data||[],isLoading:t.isLoading,isFetching:t.isFetching,error:t.error,refetch:t.refetch,create:s.mutateAsync,isCreating:s.isPending,rename:a}}(),{messages:I,isSending:E,send:T,isFetching:k}=function(e){let t=(0,v.jE)(),s=(0,y.I)({queryKey:N(e||void 0),enabled:!!e,queryFn:async()=>{if(!e)return[];let{messages:t}=await w.rh.getHistory(e);return t.map(e=>{var t,s,a,n;return e.sender&&(void 0!==e.text||void 0!==e.content)?{sender:"user"===e.sender?"user":"grace",text:String(null!=(s=null!=(t=e.text)?t:e.content)?s:""),timestamp:e.timestamp,id:e.id}:"user"===e.role?{sender:"user",text:e.content,timestamp:e.timestamp,id:e.id}:"assistant"===e.role?{sender:"grace",text:e.content,timestamp:e.timestamp,id:e.id}:e.user?{sender:"user",text:e.user,timestamp:e.timestamp,id:e.id}:e.bot?{sender:"grace",text:e.bot,timestamp:e.timestamp,id:e.id}:{sender:"grace",text:String(null!=(n=null!=(a=e.content)?a:e.text)?n:""),timestamp:e.timestamp,id:e.id}})},staleTime:15e3}),a=(0,b.n)({mutationFn:async e=>await w.rh.sendMessage(e.sessionId,e.message),onMutate:async e=>{let{sessionId:s,message:a}=e;await t.cancelQueries({queryKey:N(s)});let n=t.getQueryData(N(s)),r={sender:"user",text:a,timestamp:new Date().toISOString(),id:"tmp_".concat(Date.now())};return t.setQueryData(N(s),e=>[...e||[],r]),{prev:n}},onError:(e,s,a)=>{let{sessionId:n}=s;(null==a?void 0:a.prev)&&t.setQueryData(N(n),a.prev)},onSuccess:(e,s)=>{let{sessionId:a}=s,n={sender:"grace",text:e.response,timestamp:e.timestamp};t.setQueryData(N(a),e=>[...e||[],n])},onSettled:(e,s,a)=>{let{sessionId:n}=a;t.invalidateQueries({queryKey:N(n)})}});return{messages:s.data||[],isLoading:s.isLoading,isFetching:s.isFetching,error:s.error,refetch:s.refetch,send:t=>e?a.mutateAsync({sessionId:e,message:t}):Promise.reject(Error("No session selected")),isSending:a.isPending}}(c),[D,F]=(0,n.useState)(!1),M=(0,n.useRef)(null),P=(0,n.useRef)(null),R=(0,n.useRef)(0),O=(0,n.useRef)(!1),L=(0,n.useRef)(null),z=(0,n.useRef)({}),H=(0,n.useRef)(0),Q=(0,n.useRef)(!0),[q,X]=(0,n.useState)(!1),{initializeFromPersistedState:K,getSavedDraftMessage:G,updateDraftMessage:J,syncScrollPosition:B,getSavedScrollPosition:U}=i(c,l,u,g),W=(e,t)=>{if(e&&t&&0!==t.length)try{let a=t.slice(-50);s||localStorage.setItem("messages_".concat(e),JSON.stringify(a)),s||localStorage.setItem("lastSynced_".concat(e),new Date().toISOString()),s||localStorage.setItem("activeSessionId",e)}catch(e){console.error("Failed to store messages in localStorage:",e)}},Y=e=>{if(!e)return[];try{let t=s?null:localStorage.getItem("messages_".concat(e));if(t){let s=JSON.parse(t);if(Array.isArray(s)&&s.length>0)return console.log("Loaded cached messages for session:",e),s}}catch(e){console.error("Failed to load messages from cache:",e)}return[]},V=(0,n.useRef)(!0),Z=(0,n.useRef)(!1);(0,n.useRef)({}),(0,n.useEffect)(()=>{!D&&e&&K(o,d)&&(F(!0),console.log("Chat sessions restored from persisted state"))},[D,e,K]),(0,n.useEffect)(()=>{if(c){let e=G();e&&e!==g&&h(e)}},[c,G]),(0,n.useEffect)(()=>{c&&g&&J(g)},[c,g,J]),(0,n.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:80;return!!e&&e.scrollHeight-e.scrollTop-e.clientHeight<=t},[]),(0,n.useLayoutEffect)(()=>{if(!c||z.current[c])return;let e=U();null!==e&&setTimeout(()=>{let t=P.current;t&&"number"==typeof e&&!isNaN(e)&&(t.scrollTop=e,R.current=e)},100),z.current[c]=!0,setTimeout(()=>{Q.current=!1},200)},[c,U]);let $=(0,n.useCallback)(e=>{let t=e.currentTarget.scrollTop;R.current=t,O.current=!0,H.current=Date.now()+900,c&&(L.current&&(window.clearTimeout(L.current),L.current=null),L.current=window.setTimeout(()=>{B(t),O.current=!1},150))},[c,B]);(0,n.useEffect)(()=>()=>{V.current=!1},[]),(0,n.useEffect)(()=>{if(!e){o([]),d(null);return}if(!j)return;let t=j.map(e=>({id:e.session_id||e.id,session_id:e.session_id||e.id,name:e.name||e.topic||"New Conversation",topic:e.topic||e.name||"New Conversation",lastActivity:e.lastActivity||new Date().toISOString(),messages:[]}));if(o(t),!c&&t.length>0){let e=s?null:localStorage.getItem("activeSessionId"),a=t.find(t=>(t.session_id||t.id)===e);d(a?a.session_id||a.id:t[0].session_id||t[0].id)}F(!0)},[j,e]);let[ee,et]=(0,n.useState)(!1);(0,n.useEffect)(()=>{c&&Array.isArray(I)&&m(I)},[I,c]),(0,n.useEffect)(()=>{if(!c)return;s||localStorage.setItem("activeSessionId",c);let e=Y(c);e.length&&m(e)},[c]),(0,n.useEffect)(()=>{if(!e||!D||Z.current||0===l.length)return;console.log("Attempting to restore previous session");let t=s?null:localStorage.getItem("activeSessionId"),a=l.some(e=>(e.session_id||e.id)===t);if(t&&a)console.log("Found previous session in loaded sessions:",t),d(t);else if(l.length>0){console.log("No saved session found, selecting most recent session");let e=l.reduce((e,t)=>new Date(t.lastActivity)>new Date(e.lastActivity)?t:e);d(e.session_id||e.id)}Z.current=!0},[e,D,l.length]),(0,n.useEffect)(()=>{let e=P.current,t=M.current;if(!e||!t)return;let s=new IntersectionObserver(e=>{let[t]=e;return X(t.isIntersecting)},{root:e,threshold:.99,rootMargin:"0px 0px -1px 0px"});return s.observe(t),()=>s.disconnect()},[]),(0,n.useEffect)(()=>{!(Date.now()<H.current)&&!k&&q&&(P.current&&setTimeout(()=>{var e;let t=Q.current?"auto":"smooth";null==(e=M.current)||e.scrollIntoView({behavior:t})},100),c&&u.length>0&&W(c,u))},[u.length,c,W,k,q]);let es=(0,n.useCallback)(async()=>{if(e)try{x("");let e=await _("New Conversation"),t="string"==typeof e?e:(null==e?void 0:e.session_id)||(null==e?void 0:e.id);if(t)return d(t),s||localStorage.setItem("activeSessionId",t),m([]),t}catch(e){console.error("Failed to create new session:",e),x("Failed to create new chat session")}},[e,_]),ea=async()=>{if(!g.trim()||!e||!c)return;s||localStorage.setItem("activeSessionId",c),h("");let t=l.find(e=>e.session_id===c||e.id===c),a=t&&(!t.topic||"New Conversation"===t.topic||t.topic.startsWith("Chat ")||t.topic.startsWith("Conversation "));if(0===u.length&&a&&g){let e=(e=>{if(!e)return"New Conversation";try{let t=e.split(".")[0].trim();return(t.length>30?t.substring(0,30)+"...":t)||"New Conversation"}catch(e){return console.error("Error generating topic:",e),"New Conversation"}})(g);try{await C(c,e)}catch(e){console.warn("Prelim rename failed:",e)}}try{console.log("[Chat] sendMessage()",{sessionId:c,length:g.length}),await T(g)}catch(e){console.error("Failed to send message:",e),x("Failed to send message"),h(g)}},[en,er]=(0,n.useState)(!1),[el,ei]=(0,n.useState)(!1);(0,n.useEffect)(()=>{let e=setTimeout(()=>ei(!0),800);return()=>clearTimeout(e)},[]),(0,n.useEffect)(()=>{if("scrollRestoration"in window.history)try{window.history.scrollRestoration="manual"}catch(e){}},[]);let eo=()=>{er(!en)};return(0,a.jsxs)("div",{className:"flex h-[calc(100vh-16rem)] overflow-hidden rounded-lg border border-red-700",children:[(0,a.jsx)("button",{className:"md:hidden absolute top-2 left-2 z-10 bg-red-800 rounded-full p-2 text-white shadow-md",onClick:eo,children:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,a.jsx)("path",{fillRule:"evenodd",d:"M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z",clipRule:"evenodd"})})}),(0,a.jsxs)("aside",{className:"".concat(en?"block":"hidden"," md:block absolute md:relative md:w-64 w-3/4 bg-black border-r border-red-800 p-4 overflow-y-auto h-full z-10"),children:[(0,a.jsxs)("h2",{className:"text-red-300 text-lg font-mono mb-2 flex justify-between items-center",children:[(0,a.jsx)("span",{children:"Sessions"}),(0,a.jsx)("button",{onClick:eo,className:"md:hidden text-red-300 hover:text-red-100",children:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,a.jsx)("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]}),(0,a.jsx)("button",{onClick:()=>{es(),er(!1)},className:"w-full mb-4 rounded bg-red-700 px-4 py-2 hover:bg-red-900",disabled:!e||A,children:"+ New Chat"}),f&&(0,a.jsx)("p",{className:"text-red-500 text-xs mb-2",children:f}),!e&&(0,a.jsx)("p",{className:"text-yellow-500 text-xs mb-2",children:"Please log in to use chat"}),(0,a.jsx)("ul",{className:"space-y-2",children:l.map(e=>{let t=e.session_id||e.id;return t?(0,a.jsx)("li",{className:"relative group",children:(0,a.jsx)("button",{onClick:()=>{m([]),d(t);let e=Y(t);e.length>0&&m(e),s||localStorage.setItem("activeSessionId",t),er(!1)},className:"w-full text-left px-3 py-2 rounded text-sm hover:bg-red-800 ".concat(c===t?"bg-red-900 text-white":"text-red-300"),children:e.topic||e.name||"Chat ".concat(t.slice(0,6))})},t):null})})]}),en&&(0,a.jsx)("div",{className:"md:hidden fixed inset-0 bg-black bg-opacity-50 z-0",onClick:()=>er(!1)}),(0,a.jsxs)("main",{className:"flex-1 bg-black flex flex-col",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between border-b border-red-800/60 px-4 py-2 text-xs text-red-300/80",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"mr-2",children:"Active session:"}),(0,a.jsx)("code",{className:"bg-red-900/30 px-2 py-0.5 rounded",children:t&&(t.displayName||t.username)?t.displayName||t.username:c||"none"})]}),s?(0,a.jsx)("span",{className:"text-yellow-400",children:"persistence: off"}):(0,a.jsx)("span",{className:"text-green-400",children:"persistence: on"})]}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",onScroll:$,ref:P,style:{overscrollBehavior:"contain",overflowAnchor:"none",scrollbarGutter:"stable both-edges"},children:[0===u.length&&!E&&(0,a.jsx)("div",{className:"text-center text-gray-500 my-8",children:e?"No messages yet. Start a conversation!":"Please log in to start chatting"}),(0,a.jsx)("div",{className:"my-4 text-center",style:{minHeight:"1.5rem"},children:(0,a.jsx)("span",{className:"text-yellow-500 ".concat(E?"inline-block animate-pulse":"hidden"),"aria-live":"polite",children:"Grace is thinking..."})}),u.map((e,t)=>(0,a.jsxs)("div",{className:"mb-4",children:["user"===e.sender?(0,a.jsxs)("div",{className:"text-right p-2 rounded-lg bg-red-900/30 text-red-300",children:[(0,a.jsx)("span",{className:"font-bold",children:"You:"})," ",e.text]}):null,"grace"===e.sender?(0,a.jsxs)("div",{className:"text-left p-2 rounded-lg bg-green-900/30 text-green-300",children:[(0,a.jsx)("span",{className:"font-bold",children:"Grace:"})," ",e.text]}):null]},t)),(0,a.jsx)("div",{ref:M})]}),(0,a.jsxs)("footer",{className:"flex border-t border-red-800 bg-black p-4",children:[(0,a.jsx)("textarea",{id:"chat-input",name:"chatMessage",autoComplete:"off",autoCorrect:"off",autoCapitalize:"off",className:"flex-1 mr-2 rounded bg-white/10 p-2 text-white min-h-[60px] resize-none",placeholder:e?"Type your message... (Shift+Enter for new line)":"Please log in to chat",value:g,onChange:e=>h(e.target.value),onKeyDown:t=>{"Enter"===t.key&&!t.shiftKey&&(t.preventDefault(),!E&&e&&g.trim()&&ea())},disabled:!e||E,"aria-label":"Chat message input",ref:t=>{if(!t||!e||E)return;let s=Date.now();q&&s>H.current&&document.activeElement!==t&&setTimeout(()=>{try{t.focus()}catch(e){}},100)}}),(0,a.jsx)("button",{onClick:ea,disabled:E||!e||!g.trim(),className:"rounded bg-red-700 px-4 py-2 hover:bg-red-900 disabled:bg-gray-700 disabled:cursor-not-allowed",children:E?"...":"Send"})]}),el&&(0,a.jsx)("div",{className:"border-t border-red-800/50 p-4 bg-black/70",children:(0,a.jsxs)("div",{className:"bg-transparent text-white p-4",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,a.jsx)("h3",{className:"flex items-center text-red-500 font-bold relative pl-4 before:content-[''] before:absolute before:left-0 before:top-0 before:h-full before:w-1 before:bg-red-500",children:"XFeed Channel"}),(0,a.jsxs)("button",{onClick:()=>{let e=document.querySelector("[data-xfeed-settings]");e&&e instanceof HTMLElement&&e.click()},className:"text-xs px-2 py-1 rounded bg-red-900/50 text-red-200 hover:bg-red-800 flex items-center space-x-1",children:[(0,a.jsx)("span",{className:"text-lg leading-none",children:"+"}),(0,a.jsx)("span",{children:"Add Account"})]})]}),(0,a.jsx)("hr",{className:"border-gray-800 mb-4"}),(0,a.jsx)(p,{maxItems:3})," "]})})]})]})}},9204:(e,t,s)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/chat",function(){return s(5210)}])}},e=>{e.O(0,[317,410,636,593,792],()=>e(e.s=9204)),_N_E=e.O()}]);
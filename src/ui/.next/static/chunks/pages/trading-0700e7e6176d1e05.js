(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[347],{4040:(e,t,r)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/trading",function(){return r(4520)}])},4520:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>S});var a=r(7765),o=r(5977),s=r(8840),n=r(25),l=r(7650),i=r(9475),c=r(3846),d=r(9317),m=r(2272);let u=function(e){var t,r;let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return void 0!==m&&m.env&&m.env[e]?m.env[e]||a:(null==(r=window.import)||null==(t=r.meta)?void 0:t.env)&&window.import.meta.env[e]||a}("VITE_MANGO_V3_BASE_URL","http://mango-v3-service:8080"),g={"1m":60,"5m":300,"15m":900,"1h":3600,"4h":14400,"1d":86400};class h extends Error{constructor(e,t,r){super(e),(0,c._)(this,"statusCode",void 0),(0,c._)(this,"details",void 0),this.statusCode=t,this.details=r,this.name="MangoV3Error"}}class x{static validateMarketName(e){if(!e||"string"!=typeof e)throw new h("Market name is required and must be a string")}static validateResolution(e){if("string"==typeof e){if(!(e in g))throw new h("Unsupported resolution: ".concat(e));return g[e]}return e}static async getOHLCV(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"1h",r=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0;try{this.validateMarketName(e);let o={resolution:this.validateResolution(t).toString()};void 0!==r&&(o.start_time=Math.floor(r).toString()),void 0!==a&&(o.end_time=Math.floor(a).toString());let s=await d.A.get("".concat(u,"/api/markets/").concat(encodeURIComponent(e),"/candles"),{params:o,validateStatus:e=>e<500});if(200!==s.status)throw new h("Failed to fetch OHLCV data: ".concat(s.statusText),s.status,s.data);let n=Array.isArray(s.data)?s.data:[];if(!n.every(e=>e&&"number"==typeof e.time&&"open"in e&&"high"in e&&"low"in e&&"close"in e&&"volume"in e))throw new h("Invalid OHLCV data format received from API");return n}catch(e){if(e instanceof h)throw e;if(e.isAxiosError){var o,s;throw new h("Network error: ".concat(e.message),null==(o=e.response)?void 0:o.status,null==(s=e.response)?void 0:s.data)}throw new h("Failed to fetch OHLCV data: ".concat(e instanceof Error?e.message:String(e)))}}static async searchMarkets(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";try{let t=await d.A.get("".concat(u,"/api/markets"),{validateStatus:e=>e<500,params:{q:e}});if(200!==t.status)throw new h("Failed to search markets: ".concat(t.statusText),t.status,t.data);let r=Array.isArray(t.data)?t.data:[];if(!e)return r;let a=e.toLowerCase().trim();return r.filter(e=>{var t,r,o,s;return(null==(t=e.name)?void 0:t.toLowerCase().includes(a))||(null==(r=e.baseCurrency)?void 0:r.toLowerCase().includes(a))||(null==(o=e.quoteCurrency)?void 0:o.toLowerCase().includes(a))||(null==(s=e.address)?void 0:s.toLowerCase())===a})}catch(e){if(e instanceof h)throw e;if(e.isAxiosError){var t,r;throw new h("Network error while searching markets: ".concat(e.message),null==(t=e.response)?void 0:t.status,null==(r=e.response)?void 0:r.data)}throw new h("Failed to search markets: ".concat(e instanceof Error?e.message:String(e)))}}}var p=r(9533);let v=[{label:"1m",value:"1m"},{label:"5m",value:"5m"},{label:"15m",value:"15m"},{label:"1h",value:"1h"},{label:"4h",value:"4h"},{label:"1d",value:"1d"}],f=new Map,b=["-PERP","-USDC","/USDC","/USD","-USD"];async function y(e,t,r,a){let o="".concat(e,":").concat(t,":").concat(r||"all",":").concat(a||"all"),s=Date.now(),n=f.get(o);if(n&&s-n.timestamp<3e4&&(!r||n.timeFrom&&n.timeFrom<=r)&&(!a||n.timeTo&&n.timeTo>=a))return n.data;try{let n=a||Math.floor(Date.now()/1e3),l=r||n-86400,i=e,c=!1,d=e.toUpperCase();try{if("USDC"===d)for(let e of["BTC","SOL","ETH"])try{let t="".concat(e,"-USDC");if((await x.searchMarkets(t)).some(e=>e.name===t)){i=t,c=!0;break}}catch(t){console.error("Error checking market ".concat(e,"-USDC:"),t)}else for(let e of b)try{let t="".concat(d).concat(e);if((await x.searchMarkets(t)).some(e=>e.name===t)){i=t,c=!0,console.log("Found market by direct mapping: ".concat(i));break}}catch(e){}}catch(e){console.error("Error in APPROACH 1:",e)}if(!c)try{let t=await x.searchMarkets(e);if(t.length>0){let r=t.find(t=>{var r;return(null==(r=t.address)?void 0:r.toLowerCase())===e.toLowerCase()});r||(r=t.find(t=>{var r;return(null==(r=t.baseCurrency)?void 0:r.toLowerCase())===e.toLowerCase()})),r||((r=t.find(e=>{var t;return null==(t=e.name)?void 0:t.includes("-PERP")}))||(r=t.find(e=>{var t,r;return(null==(t=e.name)?void 0:t.includes("-USDC"))||(null==(r=e.name)?void 0:r.includes("/USDC"))})),!r&&t.length>0&&(r=t[0])),r&&r.name&&(i=r.name,c=!0,console.log("Found market ".concat(i," for token ").concat(e)))}}catch(e){console.error("Error in APPROACH 2:",e)}o="".concat(e,":").concat(i,":").concat(t,":").concat(r||"all",":").concat(a||"all");try{let e=await x.getOHLCV(i,t,l,n);return f.set(o,{data:e,timestamp:s,timeFrom:l,timeTo:n,marketName:i}),e}catch(e){throw console.error("Error fetching OHLCV data:",e),e}}catch(e){throw console.error("Error in fetchWithCache:",e),e}}let k=e=>{let{tokenAddress:t,onTokenSelect:r,selectedToken:s,resolution:n,onResolutionChange:l,onError:c,onLoading:d}=e,[m,u]=(0,o.useState)(!1),[g,f]=(0,o.useState)(null),[b,k]=(0,o.useState)(""),[w,N]=(0,o.useState)(!1),[j,C]=(0,o.useState)([]),[T,L]=(0,o.useState)(s||null),[F,S]=(0,o.useState)([]);(0,o.useEffect)(()=>(null==d||d(m),()=>{null==d||d(!1)}),[m,d]),(0,o.useEffect)(()=>(null==c||c(g),()=>{null==c||c(null)}),[g,c]);let E=(0,o.useRef)(null),A=(0,o.useRef)(null),_=(0,o.useRef)(null),R=(0,o.useRef)(null);(0,o.useEffect)(()=>()=>{A.current&&(A.current.remove(),A.current=null),R.current&&(R.current.abort(),R.current=null)},[]);let P=(0,o.useCallback)(async()=>{if(t&&_.current){R.current&&R.current.abort(),R.current=new AbortController;try{u(!0),f(null);let e=await y(t,n);if((null==e?void 0:e.length)>0){let t=e.map(e=>{let t="number"==typeof e.time?e.time:0;return{time:Math.floor(t),open:e.open,high:e.high,low:e.low,close:e.close}});if(t.length>0&&_.current)_.current.setData(t),A.current&&A.current.timeScale().fitContent();else throw new h("No valid price data available")}else throw new h("No data available for the selected token")}catch(e){if("AbortError"!==e.name){let t=e instanceof h?e.message:"Failed to load chart data";console.error("Error fetching OHLCV data:",e),f(t),c&&c(t)}}finally{u(!1),d&&d(!1)}}},[t,n,c,d]),U=(0,o.useCallback)(e=>{l(e)},[l]);(0,o.useCallback)(()=>{if(!E.current)return;A.current&&(A.current.remove(),A.current=null);let e=(0,i.R9)(E.current,{layout:{background:{type:i.mE.Solid,color:"#1E1E1E"},textColor:"#d9d9d9"},grid:{vertLines:{color:"#2b2b43"},horzLines:{color:"#2b2b43"}},width:E.current.clientWidth,height:400,timeScale:{timeVisible:!0,secondsVisible:!1}});A.current=e,_.current=e.addCandlestickSeries({upColor:"#26a69a",downColor:"#ef5350",borderVisible:!1,wickUpColor:"#26a69a",wickDownColor:"#ef5350"}),e.timeScale().fitContent();let t=()=>{A.current&&E.current&&A.current.applyOptions({width:E.current.clientWidth})};return window.addEventListener("resize",t),()=>{window.removeEventListener("resize",t),A.current&&(A.current.remove(),A.current=null)}},[]),(0,o.useEffect)(()=>{t&&P()},[t,n,P]),(0,o.useEffect)(()=>{M()},[]);let M=(0,o.useCallback)(async()=>{try{let e=(await x.searchMarkets("")).filter(e=>e.baseCurrency&&e.quoteCurrency).map(e=>({...e,price:e.price||0,marketId:e.marketId||e.address})),t=Array.from(new Map(e.map(e=>[e.baseCurrency,e])).values());S(t.slice(0,10))}catch(e){console.error("Error fetching popular tokens:",e)}},[]);return(0,a.jsxs)("div",{className:"flex flex-col h-full",children:[(0,a.jsxs)("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-2",children:[(0,a.jsxs)("div",{className:"relative w-full md:w-64",children:[(0,a.jsx)("input",{type:"text",value:b,onChange:e=>{let t=e.target.value;k(t),t.length>=3?(u(!0),N(!0),x.searchMarkets("").then(e=>{let r=e.filter(e=>e.baseCurrency&&e.quoteCurrency).map(e=>({...e,price:e.price||0,marketId:e.marketId||e.address})),a=t.toLowerCase().trim();C(r.filter(e=>e.baseCurrency&&e.baseCurrency.toLowerCase().includes(a)||e.name&&e.name.toLowerCase().includes(a)||e.quoteCurrency&&e.quoteCurrency.toLowerCase().includes(a)||e.address&&e.address.toLowerCase().includes(a))),u(!1)}).catch(e=>{console.error("Market search error:",e),C([]),u(!1)})):(N(F.length>0),C(F))},onFocus:()=>{!b&&F.length>0?(C(F),N(!0)):b.length>=3&&N(!0)},onBlur:()=>setTimeout(()=>N(!1),200),placeholder:"Search for a token...",className:"w-full p-2 rounded bg-gray-800 text-white"}),w&&j.length>0&&(0,a.jsxs)("div",{className:"absolute z-10 mt-1 w-full bg-gray-800 rounded-md shadow-lg max-h-60 overflow-auto",children:[b.length<3&&F.length>0&&(0,a.jsx)("div",{className:"px-2 py-1 text-xs text-gray-400 border-b border-gray-700",children:"Popular Tokens"}),j.map(e=>(0,a.jsxs)("div",{className:"p-2 hover:bg-gray-700 cursor-pointer flex items-center",onMouseDown:()=>(e=>{L(e),N(!1),r&&r(e)})(e),children:[e.logoURI&&(0,a.jsx)("img",{src:e.logoURI,alt:e.name||e.symbol||"Token",className:"w-6 h-6 mr-2 rounded-full"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium",children:e.symbol}),(0,a.jsx)("div",{className:"text-sm text-gray-400",children:e.name||(e.address?e.address.slice(0,8):"N/A")})]})]},e.address))]})]}),(0,a.jsx)("div",{className:"flex space-x-2 overflow-x-auto w-full md:w-auto",children:v.map(e=>(0,a.jsx)("button",{className:"px-3 py-1 rounded ".concat(n===e.value?"bg-blue-600":"bg-gray-700 hover:bg-gray-600"),onClick:()=>U(e.value),children:e.label},e.value))})]}),(0,a.jsxs)("div",{className:"flex-1 relative",children:[m&&(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-900/80 z-20",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}),g&&!m&&(0,a.jsxs)("div",{className:"absolute inset-0 flex items-center justify-center bg-red-900/50 text-red-100 p-4 z-10",children:[(0,a.jsx)("p",{children:g}),(0,a.jsx)("button",{onClick:P,className:"ml-3 px-3 py-1 bg-red-700 rounded hover:bg-red-600 transition-colors",children:"Retry"})]}),(0,a.jsx)(()=>(0,a.jsx)(p.A,{fallback:(0,a.jsx)("div",{className:"flex items-center justify-center h-full bg-red-900/20 text-red-200 p-4",children:(0,a.jsx)("p",{children:"Chart failed to load. Please try again."})}),children:(0,a.jsx)("div",{ref:E,className:"w-full h-full"})}),{})]})]})};var w=r(4238),N=r(9447),j=r(929),C=r.n(j);let T={tokens:[],selectedToken:null,transactions:[],isLoading:{tokens:!0,transactions:!1,trading:!1},error:null,resolution:"1h",search:"",tradeForm:{amount:"",leverage:5,isLeverage:!0,isSmartTrade:!1,stopLoss:5,takeProfit:10,orderType:"market",limitPrice:""}},L=e=>{try{if(!e||"object"!=typeof e)return console.warn("Invalid token data:",e),null;let t=String(e.address||e.mintAddress||"").toLowerCase().trim();if(!t)return console.warn("Token missing address:",e),null;let r=String(e.baseCurrency||e.symbol||"").toUpperCase().trim(),a=String(e.quoteCurrency||"USDC").toUpperCase().trim(),o=e.name||"".concat(r,"-").concat(a),s="number"!=typeof e.price||isNaN(e.price)?0:e.price,n={name:o,address:t,baseCurrency:r,quoteCurrency:a,price:s,marketId:e.marketId||""};return e.symbol&&(n.symbol=e.symbol.toUpperCase().trim()),e.logoURI&&(n.logoURI=e.logoURI),void 0!==e.decimals&&(n.decimals=e.decimals),n.source="mango",n.canTrade=!0,n.canChart=!0,n}catch(t){return console.error("Error processing token:",t,e),null}},F=()=>{let{user:e}=(0,s.A)(),{state:t,dispatch:r}=(0,n.A)(),i=t.tradingState||{},[c,d]=(0,o.useState)({...T,selectedToken:i.selectedToken||T.selectedToken,resolution:i.resolution||T.resolution,search:i.search||T.search,tradeForm:{...T.tradeForm,...i.tradeForm||{}}}),m=(0,o.useRef)(null);(0,o.useEffect)(()=>{(c.tokens.length>0||c.selectedToken)&&r({type:"SET_TRADING_STATE",payload:{selectedToken:c.selectedToken,resolution:c.resolution,search:c.search,tradeForm:c.tradeForm,positions:c.selectedToken?[c.selectedToken]:[]}})},[c.selectedToken,c.resolution,c.search,c.tradeForm,r]);let u=(0,o.useMemo)(()=>({setTokens:e=>{console.log("Setting tokens:",e),d(t=>({...t,tokens:e}))},selectToken:e=>{console.log("Selecting token:",null==e?void 0:e.name),d(t=>({...t,selectedToken:e}))},setTransactions:e=>{d(t=>({...t,transactions:e}))},setLoading:e=>{d(t=>({...t,isLoading:{...t.isLoading,...e}}))},setError:e=>{console.error("Trading error:",e),d(t=>({...t,error:e,isLoading:{...t.isLoading,tokens:!1,trading:!1}})),e&&w.oR.error(e)},setResolution:e=>{console.log("Setting resolution:",e),d(t=>({...t,resolution:e,isLoading:{...t.isLoading,trading:!0}}))},setSearch:e=>{d(t=>({...t,search:e}))},updateTradeForm:e=>{d(t=>({...t,tradeForm:{...t.tradeForm,...e}}))},toggleLeverage:()=>{d(e=>({...e,tradeForm:{...e.tradeForm,isLeverage:!e.tradeForm.isLeverage,leverage:e.tradeForm.isLeverage?1:5}}))},toggleSmartTrade:()=>{d(e=>({...e,tradeForm:{...e.tradeForm,isSmartTrade:!e.tradeForm.isSmartTrade}}))},toggleOrderType:()=>{d(e=>({...e,tradeForm:{...e.tradeForm,orderType:"market"===e.tradeForm.orderType?"limit":"market",limitPrice:"limit"===e.tradeForm.orderType?e.tradeForm.limitPrice:""}}))}}),[]),g=async e=>{let t=e=>void 0===e?"N/A":e.toLocaleString(void 0,{maximumFractionDigits:6}),r="\n      Please confirm your trade:\n      \n      ".concat(e.action.toUpperCase()," ").concat(e.amount," ").concat(e.token,"\n      Price: $").concat(t(e.price),"\n      Total: $").concat(t(e.total),"\n      ").concat(e.stopLoss?"Stop Loss: $".concat(t(e.stopLoss)):"","\n      ").concat(e.takeProfit?"Take Profit: $".concat(t(e.takeProfit)):"","\n    ");return window.confirm(r)},h=(0,o.useCallback)(async e=>{if(!c.selectedToken||!c.tradeForm.amount)return void w.oR.error("Please select a token and enter an amount");if("limit"===c.tradeForm.orderType&&!c.tradeForm.limitPrice)return void w.oR.error("Please enter a limit price");try{if(u.setLoading({trading:!0}),"limit"===c.tradeForm.orderType){let t={market:c.selectedToken.symbol,side:e,price:parseFloat(c.tradeForm.limitPrice),size:parseFloat(c.tradeForm.amount),trade_type:c.tradeForm.isLeverage?"leverage":"spot",leverage:c.tradeForm.isLeverage?c.tradeForm.leverage:void 0,reduce_only:!1,client_id:"".concat(Date.now(),"-").concat(Math.random().toString(36).substring(2,9))};try{let r=await l.FH.post(l.Sn.USER.LIMIT_ORDERS,t);if(r.success)w.oR.success("".concat(e.toUpperCase()," limit order placed successfully at $").concat(c.tradeForm.limitPrice)),N.U.emit("trade:confirmed",{type:"limit_order_placed",data:r,trade:{action:e,token:c.selectedToken.symbol,amount:c.tradeForm.amount,price:c.tradeForm.limitPrice,isLeverage:c.tradeForm.isLeverage,timestamp:Date.now()}});else throw Error(r.error||"Failed to place limit order")}catch(e){console.error("Limit order placement error:",e),w.oR.error("Limit order failed: ".concat(e.message||"Unknown error"))}}else{var t;let r={action:e,token:c.selectedToken.symbol,amount:c.tradeForm.amount,isLeverage:c.tradeForm.isLeverage,leverage:c.tradeForm.isLeverage?c.tradeForm.leverage:void 0,stopLoss:c.tradeForm.stopLoss,takeProfit:c.tradeForm.takeProfit,isSmartTrade:c.tradeForm.isSmartTrade},a=await l.S1.executeTrade(r);if((null==(t=a.result)?void 0:t.status)==="confirmation_required"&&a.result.confirmation_id){let t={token:c.selectedToken.symbol,action:e,amount:c.tradeForm.amount,price:a.result.current_price,total:a.result.estimated_total,stopLoss:a.result.stop_loss_price,takeProfit:a.result.take_profit_price};if(!await g(t))return void w.oR.info("Trade canceled by user");{let t=await l.S1.confirmTrade(a.result.confirmation_id);if(t.success)w.oR.success("".concat(e.toUpperCase()," order executed successfully")),N.U.emit("trade:confirmed",{type:"trade_confirmed",data:t,trade:{action:e,token:c.selectedToken.symbol,amount:c.tradeForm.amount,isLeverage:c.tradeForm.isLeverage,timestamp:Date.now()}});else throw Error(t.error||"Trade confirmation failed")}}else if(a.success)w.oR.success("".concat("buy"===e?"Buy":"Sell"," order placed successfully"));else throw Error(a.error||"Failed to execute trade")}}catch(e){console.error("Trade execution error:",e),w.oR.error("Trade failed: ".concat(e.message||"Unknown error"))}finally{u.setLoading({trading:!1})}},[c.selectedToken,c.tradeForm,u]),x=(0,o.useCallback)(async e=>{if(!(null==e?void 0:e.address)){let t="Invalid token: Missing address";console.error(t,e),u.setError(t);return}console.log("Selected token: ".concat(e.name," (").concat(e.address,")")),u.selectToken(e),u.setSearch(""),u.setTokens([]),u.updateTradeForm({amount:""}),u.setLoading({trading:!0});try{let t=Math.floor(Date.now()/1e3),r=t-86400;console.log("Fetching OHLCV data for ".concat(e.symbol," (").concat(e.address,")")),console.log("- Resolution: ".concat(c.resolution||"1h")),console.log("- Time range: ".concat(new Date(1e3*r).toISOString()," to ").concat(new Date(1e3*t).toISOString()));let a=e.name||"".concat(e.baseCurrency,"-").concat(e.quoteCurrency)||e.address;console.log("Using market name for OHLCV request: ".concat(a));let o=await MangoV3Service.getOHLCV(a,c.resolution||"1h",r,t);if(console.log("Received ".concat(o.length," data points")),!o||0===o.length)throw Error("No price data available for this token");let s=o[o.length-1],n={...e,price:s.close,change_24h:(s.close-o[0].open)/o[0].open*100,volume_24h:o.reduce((e,t)=>e+(t.volume||0),0)};console.log("Updated token data:",{price:n.price,change_24h:n.change_24h,volume_24h:n.volume_24h}),u.selectToken(n)}catch(t){let e=t instanceof Error?"Failed to load token data: ".concat(t.message):"Failed to load token data";console.error(e,t),u.setError(e)}finally{u.setLoading({trading:!1})}},[c.resolution,u]),v=(0,o.useCallback)(e=>{try{if(!/^\d+[mhd]$/.test(e))throw Error("Invalid resolution format. Use format like 1m, 5m, 1h, etc.");MangoV3Service.getOHLCV("SOL-PERP",e).then(()=>{console.log("Valid resolution: ".concat(e)),u.setResolution(e),c.selectedToken&&u.setLoading({trading:!0})}).catch(e=>{console.error("Invalid resolution:",e),u.setError("This resolution is not supported")})}catch(e){console.error("Resolution validation error:",e),u.setError(e instanceof Error?e.message:"Invalid resolution")}},[u,c.selectedToken]),f=(0,o.useMemo)(()=>({"1m":"1 minute","5m":"5 minutes","15m":"15 minutes","1h":"1 hour","4h":"4 hours","1d":"1 day"}),[]),b=(0,o.useCallback)(async()=>{if(e)try{u.setLoading({transactions:!0});let e=await l.FH.get("".concat(l.Sn.MANGO.TRADES,"?limit=10"));e&&Array.isArray(e.data)?u.setTransactions(e.data):(console.warn("Invalid transaction data format:",e),u.setTransactions([]))}catch(e){console.error("Error fetching transactions:",e),u.setTransactions([])}finally{u.setLoading({transactions:!1})}},[e,u]),y=(0,o.useCallback)(async e=>{if(!e)return null;try{let t=await l.FH.get("".concat(l.Sn.TRADING.TOKENS,"/").concat(e));if(t&&t.data){let e=L(t.data);if(e)return u.selectToken(e),e}return null}catch(t){return console.error("Error fetching token info for ".concat(e,":"),t),null}},[u]);(0,o.useEffect)(()=>{let e=e=>{console.log("Trade confirmed event received:",e),b(),c.selectedToken&&e.trade&&e.trade.token===c.selectedToken.symbol&&y(c.selectedToken.symbol)};return N.U.on("trade:confirmed",e),()=>{N.U.off("trade:confirmed",e)}},[c.selectedToken,b,y]);let j=(0,o.useCallback)(C()(async e=>{let t=e.trim();if(console.log("Searching for tokens with query:",t),!t){console.log("Empty search query, clearing tokens"),u.setTokens([]);return}m.current&&(console.log("Cancelling previous search request"),m.current.abort()),m.current=new AbortController,u.setLoading({tokens:!0});try{console.log("Fetching tokens from Mango V3 API...");let e=await MangoV3Service.searchMarkets(t.length>=3?t:"");console.log("Received ".concat(e.length," tokens from API"));let r=e.map(L).filter(e=>null!==e),a=t.length>=3?r.filter(e=>{var r,a,o;let s=t.toLowerCase();return e.symbol.toLowerCase().includes(s)||e.name.toLowerCase().includes(s)||(null==(r=e.baseCurrency)?void 0:r.toLowerCase().includes(s))||(null==(a=e.quoteCurrency)?void 0:a.toLowerCase().includes(s))||(null==(o=e.address)?void 0:o.toLowerCase().includes(s))}):r;console.log("Displaying ".concat(a.length," tokens after filtering")),u.setTokens(a),u.setError(null)}catch(t){if("AbortError"===t.name)return void console.log("Search was cancelled");console.error("Error fetching tokens:",t);let e=t instanceof Error?t.message:"Failed to fetch tokens";u.setError(e)}finally{u.setLoading({tokens:!1})}},300),[]),F=(0,o.useCallback)(e=>{let t=e.target.value;u.setSearch(t),(""===t||t.length>=3)&&j(t)},[j,u]),[S,E]=(0,o.useState)({balances:{},loading:!1,error:null});(0,o.useCallback)(async()=>{if(e)try{E(e=>({...e,loading:!0,error:null}));let e=await l.FH.get(l.Sn.WALLET.BALANCE);if(e.success&&e.data){let t=e.data,r={};Array.isArray(t.tokens)&&t.tokens.forEach(e=>{e.symbol&&"number"==typeof e.amount&&(r[e.symbol.toUpperCase()]=e.amount)}),console.log("Wallet balances loaded:",r),E({balances:r,loading:!1,error:null})}else throw Error(e.error||"Failed to load wallet balances")}catch(e){console.error("Error fetching wallet balances:",e),E(t=>({...t,loading:!1,error:e instanceof Error?e.message:"Failed to load wallet balances"}))}},[e]),(0,o.useEffect)(()=>(j(""),()=>{m.current&&m.current.abort()}),[j]);let A=(0,o.useCallback)((e,t)=>{if(!t||isNaN(parseFloat(t)))return!0;let r=e.toUpperCase(),a=S.balances[r]||0;return parseFloat(t)<=a},[S.balances]);return(0,a.jsx)(p.A,{children:(0,a.jsxs)("div",{className:"container mx-auto px-4 py-8",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold mb-6",children:"Trading"}),c.error&&(0,a.jsx)("div",{className:"bg-red-900/50 border border-red-500 text-white px-4 py-3 rounded mb-4",children:c.error}),(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6",children:[(0,a.jsx)("div",{className:"lg:col-span-1",children:(0,a.jsxs)("div",{className:"bg-gray-900 rounded-lg p-4 h-full",children:[(0,a.jsx)("div",{className:"mb-4",children:(0,a.jsx)("input",{type:"text",placeholder:"Search tokens...",className:"w-full p-2 bg-gray-800 text-white rounded",value:c.search,onChange:F})}),(0,a.jsxs)("div",{className:"space-y-2 max-h-[500px] overflow-y-auto",children:[c.tokens.map(e=>{var t,r;return(0,a.jsx)("div",{className:"p-3 rounded-lg cursor-pointer hover:bg-gray-800 ".concat((null==(t=c.selectedToken)?void 0:t.address)===e.address?"bg-blue-900":"bg-gray-800"),onClick:()=>x(e),children:(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium",children:e.symbol}),(0,a.jsx)("div",{className:"text-sm text-gray-400",children:e.name}),e.baseCurrency&&e.quoteCurrency&&(0,a.jsxs)("div",{className:"text-xs text-blue-400 mt-1",children:[e.baseCurrency,"/",e.quoteCurrency]})]}),(0,a.jsxs)("div",{className:"text-right",children:[(0,a.jsxs)("div",{children:["$",(null==(r=e.price)?void 0:r.toFixed(6))||"N/A"]}),(0,a.jsx)("div",{className:"text-sm ".concat((e.change_24h||0)>=0?"text-green-400":"text-red-400"),children:e.change_24h?"".concat(e.change_24h.toFixed(2),"%"):"N/A"})]})]})},e.address)}),c.isLoading.tokens&&(0,a.jsx)("div",{className:"text-center py-4",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"})}),!c.isLoading.tokens&&0===c.tokens.length&&c.search&&(0,a.jsx)("div",{className:"text-center py-4 text-gray-400",children:"No tokens found"})]})]})}),(0,a.jsx)("div",{className:"lg:col-span-2",children:(()=>{var e,t,r;return(0,a.jsx)("div",{className:"bg-gray-900 rounded-lg p-4",children:c.selectedToken?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,a.jsxs)("h2",{className:"text-xl font-bold",children:[c.selectedToken.symbol,(0,a.jsxs)("span",{className:"ml-2 text-sm text-gray-400",children:["$",(null==(e=c.selectedToken.price)?void 0:e.toFixed(6))||"N/A"]})]}),(0,a.jsx)("div",{className:"text-sm ".concat((c.selectedToken.change_24h||0)>=0?"text-green-400":"text-red-400"),children:c.selectedToken.change_24h?"".concat(c.selectedToken.change_24h.toFixed(2),"%"):"N/A"})]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(()=>{let e=Object.entries(S.balances).filter(e=>{let[t]=e;return c.selectedToken&&c.selectedToken.symbol,!0}).sort((e,t)=>t[1]-e[1]).slice(0,5);return(0,a.jsxs)("div",{className:"mb-4 p-3 bg-gray-800 rounded-lg",children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-gray-400 mb-2",children:"Wallet Balances"}),S.loading?(0,a.jsx)("div",{className:"text-center py-1",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500 mx-auto"})}):S.error?(0,a.jsx)("div",{className:"text-xs text-red-400",children:S.error}):e.length>0?(0,a.jsx)("div",{className:"space-y-1",children:e.map(e=>{let[t,r]=e;return(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)("span",{className:"text-sm font-medium",children:t}),(0,a.jsx)("span",{className:"text-sm text-gray-300",children:r.toFixed(6)})]},t)})}):(0,a.jsx)("div",{className:"text-xs text-gray-500",children:"No balances available"})]})})(),(0,a.jsxs)("div",{className:"flex items-center justify-between bg-gray-800 rounded p-2",children:[(0,a.jsx)("div",{className:"text-sm text-gray-400",children:"Order Type:"}),(0,a.jsxs)("div",{className:"flex bg-gray-700 rounded overflow-hidden",children:[(0,a.jsx)("button",{className:"px-3 py-1 text-sm ".concat("market"===c.tradeForm.orderType?"bg-blue-600 text-white":"bg-gray-700 text-gray-300 hover:bg-gray-600"),onClick:()=>"market"!==c.tradeForm.orderType&&u.toggleOrderType(),children:"Market"}),(0,a.jsx)("button",{className:"px-3 py-1 text-sm ".concat("limit"===c.tradeForm.orderType?"bg-blue-600 text-white":"bg-gray-700 text-gray-300 hover:bg-gray-600"),onClick:()=>"limit"!==c.tradeForm.orderType&&u.toggleOrderType(),children:"Limit"})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm text-gray-400 mb-1",children:"Amount"}),(0,a.jsx)("input",{type:"number",className:"w-full p-2 ".concat(c.selectedToken&&!A(c.selectedToken.symbol,c.tradeForm.amount)?"bg-red-900/30 border border-red-500":"bg-gray-800"," text-white rounded"),value:c.tradeForm.amount,onChange:e=>u.updateTradeForm({amount:e.target.value}),placeholder:"0.0"}),c.selectedToken&&!A(c.selectedToken.symbol,c.tradeForm.amount)&&(0,a.jsxs)("div",{className:"text-xs text-red-400 mt-1",children:["Insufficient balance for ",c.selectedToken.symbol]})]}),"limit"===c.tradeForm.orderType&&(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm text-gray-400 mb-1",children:"Limit Price ($)"}),(0,a.jsx)("input",{type:"number",className:"w-full p-2 bg-gray-800 text-white rounded",value:c.tradeForm.limitPrice,onChange:e=>u.updateTradeForm({limitPrice:e.target.value}),placeholder:(null==(r=c.selectedToken)||null==(t=r.price)?void 0:t.toFixed(6))||"0.0"})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("button",{className:"px-3 py-1 rounded ".concat(c.tradeForm.isLeverage?"bg-blue-600 hover:bg-blue-700":"bg-gray-700 hover:bg-gray-600"),onClick:u.toggleLeverage,children:"Leverage"}),c.tradeForm.isLeverage&&(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("span",{className:"text-sm text-gray-400",children:"Amount:"}),(0,a.jsx)("input",{type:"number",min:"1",max:"20",className:"w-16 p-1 bg-gray-800 text-white rounded text-center",value:c.tradeForm.leverage,onChange:e=>u.updateTradeForm({leverage:Math.min(20,Math.max(1,Number(e.target.value)||1))})}),(0,a.jsx)("span",{className:"text-sm",children:"x"})]}),(0,a.jsx)("button",{className:"px-3 py-1 rounded ".concat(c.tradeForm.isSmartTrade?"bg-blue-600 hover:bg-blue-700":"bg-gray-700 hover:bg-gray-600"),onClick:u.toggleSmartTrade,children:"Smart Trade"})]}),c.tradeForm.isSmartTrade&&(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm text-gray-400 mb-1",children:"Stop Loss (%)"}),(0,a.jsx)("input",{type:"number",min:"0",step:"0.1",className:"w-full p-2 bg-gray-800 text-white rounded",value:c.tradeForm.stopLoss,onChange:e=>u.updateTradeForm({stopLoss:Math.max(0,Number(e.target.value)||0)})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm text-gray-400 mb-1",children:"Take Profit (%)"}),(0,a.jsx)("input",{type:"number",min:"0",step:"0.1",className:"w-full p-2 bg-gray-800 text-white rounded",value:c.tradeForm.takeProfit,onChange:e=>u.updateTradeForm({takeProfit:Math.max(0,Number(e.target.value)||0)})})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsx)("button",{className:"bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded ".concat(c.isLoading.trading?"opacity-50 cursor-not-allowed":""),onClick:()=>h("buy"),disabled:c.isLoading.trading,children:c.isLoading.trading?"Processing...":"Buy"}),(0,a.jsx)("button",{className:"bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded ".concat(c.isLoading.trading?"opacity-50 cursor-not-allowed":""),onClick:()=>h("sell"),disabled:c.isLoading.trading,children:c.isLoading.trading?"Processing...":"Sell"})]})]})]}):(0,a.jsx)("div",{className:"text-center py-8 text-gray-400",children:"Select a token to start trading"})})})()})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,a.jsx)("div",{className:"lg:col-span-2",children:(0,a.jsx)("div",{className:"bg-gray-900 rounded-lg p-4 h-full",children:c.selectedToken?(0,a.jsxs)("div",{className:"h-full flex flex-col",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,a.jsx)("h3",{className:"text-lg font-medium",children:"Price Chart"}),(0,a.jsx)("div",{className:"flex space-x-2",children:Object.entries(f).map(e=>{let[t,r]=e;return(0,a.jsx)("button",{className:"px-2 py-1 text-sm rounded ".concat(c.resolution===t?"bg-blue-600 text-white":"bg-gray-800 text-gray-300 hover:bg-gray-700"),onClick:()=>v(t),children:t},t)})})]}),(0,a.jsx)("div",{className:"flex-1 min-h-[300px]",children:(0,a.jsx)(k,{tokenAddress:c.selectedToken.address,selectedToken:c.selectedToken,resolution:c.resolution,onError:u.setError,onLoading:e=>u.setLoading({trading:e}),onResolutionChange:v,onTokenSelect:x})})]}):(0,a.jsx)("div",{className:"flex items-center justify-center h-full text-gray-400",children:"Select a token to view chart"})})}),(0,a.jsx)("div",{className:"lg:col-span-1",children:(()=>{let e=Array.isArray(c.transactions)?c.transactions:[];return(0,a.jsxs)("div",{className:"bg-gray-900 rounded-lg p-4 h-full",children:[(0,a.jsx)("h3",{className:"text-lg font-medium mb-4",children:"Recent Trades"}),c.isLoading.transactions?(0,a.jsx)("div",{className:"text-center py-4",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"})}):e.length>0?(0,a.jsx)("div",{className:"space-y-2",children:e.map((e,t)=>{var r;let o=(null==e||null==(r=e.side)?void 0:r.toLowerCase())==="sell"?"sell":"buy",s=(null==e?void 0:e.symbol)||"TOKEN",n=(null==e?void 0:e.amount)?Number(e.amount).toFixed(4):"0",l=(null==e?void 0:e.price)?"$".concat(Number(e.price).toFixed(6)):"$0",i=(null==e?void 0:e.timestamp)?new Date(e.timestamp).toLocaleString():"Just now";return(0,a.jsxs)("div",{className:"flex justify-between items-center p-2 bg-gray-800 rounded",children:[(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("div",{className:"w-3 h-3 rounded-full mr-2 ".concat("buy"===o?"bg-green-500":"bg-red-500")}),(0,a.jsx)("span",{className:"font-medium",children:s})]}),(0,a.jsxs)("div",{className:"text-right",children:[(0,a.jsxs)("div",{className:"buy"===o?"text-green-400":"text-red-400",children:[o.toUpperCase()," ",n," @ ",l]}),(0,a.jsx)("div",{className:"text-xs text-gray-400",children:i})]})]},t)})}):(0,a.jsx)("div",{className:"text-center py-8 text-gray-400",children:"No recent trades found"})]})})()})]})]})})},S=()=>(0,a.jsx)(p.A,{children:(0,a.jsx)(F,{})})}},e=>{e.O(0,[196,317,440,447,636,593,792],()=>e(e.s=4040)),_N_E=e.O()}]);
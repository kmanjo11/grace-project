(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[106],{1652:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>H});var a=s(8153),o=s(4232),n=s(4054),i=s(6874),r=s(9923),l=s(701);let c=function(e,t,s){var a,n;let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",{state:r,dispatch:c}=(0,l.A)(),d=()=>{var e;if((null==(e=r.chatState)?void 0:e.sessions)&&Object.keys(r.chatState.sessions).length>0)return Object.values(r.chatState.sessions||{}).map(e=>({id:e.id||e.session_id||"",session_id:e.session_id||e.id||"",name:e.name||e.topic||"Chat ".concat((e.session_id||e.id||"").slice(0,6)),topic:e.topic||e.name||"",lastActivity:e.updated_at||new Date().toISOString(),messages:Array.isArray(e.messages)?e.messages.map(e=>({sender:"user"===e.role?"user":"grace",text:e.content||"",timestamp:e.timestamp||new Date().toISOString(),user:"user"===e.role?e.content:void 0,bot:"assistant"===e.role?e.content:void 0})):[],scrollPosition:e.scrollPosition,unread_count:e.unread_count||0}));let t=localStorage.getItem("activeSessionId");if(t)try{let e=g(t);if(e.length>0)return[{id:t,session_id:t,name:"Chat ".concat(t.slice(0,6)),topic:"Chat ".concat(t.slice(0,6)),lastActivity:localStorage.getItem("lastSynced_".concat(t))||new Date().toISOString(),messages:e}]}catch(e){console.error("Error loading sessions from cache:",e)}return[]},g=e=>{if(!e)return[];try{var t,s,a;let o=null==(a=r.chatState)||null==(s=a.sessions)||null==(t=s[e])?void 0:t.messages;if(Array.isArray(o)&&o.length>0)return console.log("Restoring ".concat(o.length," messages from global state for session ").concat(e)),o.map(e=>({sender:"user"===e.role?"user":"grace",text:e.content||"",timestamp:e.timestamp||new Date().toISOString(),user:"user"===e.role?e.content:void 0,bot:"assistant"===e.role?e.content:void 0}));let n=localStorage.getItem("messages_".concat(e));if(n){let t=JSON.parse(n);if(Array.isArray(t)&&t.length>0)return console.log("Restoring ".concat(t.length," messages from localStorage for session ").concat(e)),t}}catch(e){console.error("Error loading messages from cache:",e)}return[]};(0,o.useEffect)(()=>{let e=d();e.length>0&&0===t.length&&console.log("Chat sessions available in persistent state",e)},[null==(a=r.chatState)?void 0:a.sessions,t]),(0,o.useEffect)(()=>{if(e&&t.length>0){var s;let a=t.reduce((e,t)=>{let s=t.session_id||t.id;return s&&(e[s]={id:t.id,session_id:t.session_id||t.id,topic:t.topic||t.name,name:t.name,created_at:t.created_at||t.lastActivity,updated_at:t.lastActivity||new Date().toISOString(),preview_message:t.messages&&t.messages.length>0?t.messages[t.messages.length-1].text||t.messages[t.messages.length-1].user||t.messages[t.messages.length-1].bot:"",messages:t.messages.map(e=>({id:e.timestamp||new Date().toISOString(),content:e.text||e.user||e.bot||"",role:"user"===e.sender?"user":"assistant",timestamp:e.timestamp||new Date().toISOString()})),scrollPosition:t.scrollPosition,unread_count:t.unread_count||0}),e},{});c({type:"SET_CHAT_STATE",payload:{activeSessions:t.map(e=>e.session_id||e.id),currentSessionId:e,sessions:a,draftMessages:{...(null==(s=r.chatState)?void 0:s.draftMessages)||{},[e]:i}}});let o=t.find(t=>t.id===e||t.session_id===e);o&&o.messages&&u(e,o.messages)}},[t,e,s,i,c]),(0,o.useEffect)(()=>{var t;if(e&&s.length>0&&(null==(t=r.chatState)?void 0:t.sessions)){let t=r.chatState.sessions[e];t&&!m(t.messages||[],s)&&c({type:"SET_CHAT_STATE",payload:{sessions:{...r.chatState.sessions,[e]:{...t,messages:s,updated_at:new Date().toISOString()}}}})}},[s,e,null==(n=r.chatState)?void 0:n.sessions,c]);let m=(e,t)=>e.length===t.length&&e.length===t.length,u=(e,t)=>{if(e&&t)try{var s,a,o,n;console.log("Persisting ".concat(t.length," messages for session ").concat(e));let i=t.slice(-100);localStorage.setItem("messages_".concat(e),JSON.stringify(i)),localStorage.setItem("lastSynced_".concat(e),new Date().toISOString()),localStorage.setItem("activeSessionId",e);let l=i.map(e=>({id:Math.random().toString(36).substring(2,15),content:e.text||e.user||e.bot||"",role:"user"===e.sender||e.user?"user":"assistant",timestamp:e.timestamp||new Date().toISOString()}));c({type:"SET_CHAT_CONTEXT",payload:{currentConversationId:e,lastMessageTimestamp:new Date().getTime()}}),c({type:"SET_CHAT_STATE",payload:{currentSessionId:e,sessions:{...(null==(s=r.chatState)?void 0:s.sessions)||{},[e]:{id:e,session_id:e,messages:l,updated_at:new Date().toISOString(),...(null==(o=r.chatState)||null==(a=o.sessions)?void 0:a[e])||{},preview_message:(null==(n=i[i.length-1])?void 0:n.text)||""}}}})}catch(e){console.error("Failed to store messages:",e)}};return{initializeFromPersistedState:(e,s)=>{let a=d();if(a.length>0&&0===t.length){var o,n;e(a);let t=localStorage.getItem("activeSessionId");return s(t?a.some(e=>e.session_id===t||e.id===t)?t:(null==(n=r.chatState)?void 0:n.currentSessionId)?r.chatState.currentSessionId:a[0].session_id||a[0].id:(null==(o=r.chatState)?void 0:o.currentSessionId)?r.chatState.currentSessionId:a[0].session_id||a[0].id),!0}return!1},getStoredSessions:d,loadMessagesFromCache:g,persistMessages:u,syncScrollPosition:t=>{var s,a,o;e&&(localStorage.setItem("scrollPosition_".concat(e),t.toString()),c({type:"SET_CHAT_STATE",payload:{sessions:{...(null==(s=r.chatState)?void 0:s.sessions)||{},[e]:{...(null==(o=r.chatState)||null==(a=o.sessions)?void 0:a[e])||{},scrollPosition:t}}}}))},getSavedScrollPosition:()=>{var t,s;if(!e)return null;let a=localStorage.getItem("scrollPosition_".concat(e));return a?parseInt(a,10):(null==(s=r.chatState)||null==(t=s.sessions)?void 0:t[e])?r.chatState.sessions[e].scrollPosition:null},getSavedDraftMessage:()=>{var t;if(!e)return"";let s=localStorage.getItem("draft_".concat(e));return s||(null==(t=r.chatState)?void 0:t.draftMessages)&&e in r.chatState.draftMessages&&r.chatState.draftMessages[e]||""},updateDraftMessage:t=>{var s;e&&(localStorage.setItem("draft_".concat(e),t),c({type:"SET_CHAT_STATE",payload:{draftMessages:{...(null==(s=r.chatState)?void 0:s.draftMessages)||{},[e]:t}}}))}}};var d=s(1054),g=s(6520),m=s(1428),u=s(4527),h=s(2643),f=s(5965),p=s(2460),S=s(2482),v=s(2594),y=s(2039),b=s(6613),w=s(5657),x=s(7444),A=s(4293),_=s(1095),I=s(9299),D=s(510),N=s(3694),Y=s(2528),C=s(573),T=s(3943),F=s(2989),E=s(2781),k=s(1040);let O=e=>{var t;let{maxItems:s=5}=e,{state:n,dispatch:i}=(0,l.A)(),[r,c]=(0,o.useState)([]),[O,H]=(0,o.useState)(!1),[P,M]=(0,o.useState)(null),[z,R]=(0,o.useState)(!1),[J,L]=(0,o.useState)(""),X=(null==(t=n.xfeed)?void 0:t.followedAccounts)||[];(0,o.useEffect)(()=>{X.length>0&&W()},[X]);let W=async()=>{if(0!==X.length){H(!0),M(null);try{let e=X.map(e=>{let t="from:".concat(e.replace("@",""));return console.log("Fetching tweets for ".concat(e," with query: ").concat(t)),k.A.get("/api/social/tweets",{params:{query:t,search_type:"tweets",count:Math.ceil(s/X.length),include_media:!0}})}),t=await Promise.all(e),a=[];t.forEach((e,t)=>{let s=e.data.data||{};if(s.results&&Array.isArray(s.results)){let e=s.results.map(e=>{var s,a,o;return{id:e.id,text:e.text,created_at:e.created_at,username:(null==(s=e.user)?void 0:s.username)||X[t],name:(null==(a=e.user)?void 0:a.name)||X[t],profile_image_url:null==(o=e.user)?void 0:o.profile_image_url,media:e.media,heat_score:j(e),likes_count:e.likes_count||0,retweets_count:e.retweets_count||0}});a=[...a,...e]}}),a.sort((e,t)=>new Date(t.created_at).getTime()-new Date(e.created_at).getTime()),c(a.slice(0,s))}catch(e){console.error("Error fetching tweets:",e),M("Failed to load tweets. Please try again later.")}finally{H(!1)}}},j=e=>{let t=e.likes_count||0,s=e.retweets_count||0,a=new Date(e.created_at),o=(new Date().getTime()-a.getTime())/36e5;return Math.min(100,Math.round((+t+2*s+100*(o<24?(24-o)/24:0)*3)/10))};return(0,a.FD)(d.A,{elevation:1,sx:{width:"100%",p:1,borderRadius:2,height:"100%",maxHeight:"600px",overflow:"hidden",display:"flex",flexDirection:"column"},children:[(0,a.FD)(g.A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1,flexShrink:0},children:[(0,a.Y)(m.A,{variant:"subtitle1",sx:{fontWeight:"bold"},children:"X Feed"}),(0,a.FD)(g.A,{children:[(0,a.Y)(u.A,{onClick:W,disabled:O,size:"small",children:(0,a.Y)(C.A,{fontSize:"small"})}),(0,a.Y)(u.A,{onClick:()=>R(!0),size:"small","data-xfeed-settings":!0,children:(0,a.Y)(T.A,{fontSize:"small"})})]})]}),(0,a.Y)(g.A,{sx:{overflow:"auto",flex:1},children:0===X.length?(0,a.FD)(g.A,{sx:{mb:1,p:2,textAlign:"center",bgcolor:"background.paper",borderRadius:1},children:[(0,a.Y)(m.A,{variant:"body2",sx:{mb:1},children:"No accounts added"}),(0,a.Y)(h.A,{variant:"outlined",size:"small",startIcon:(0,a.Y)(F.A,{}),onClick:()=>R(!0),children:"Add Accounts"})]}):O?(0,a.Y)(g.A,{sx:{display:"flex",justifyContent:"center",py:2},children:(0,a.Y)(f.A,{size:24})}):P?(0,a.Y)(g.A,{sx:{mb:1,p:1,bgcolor:"error.main",color:"white",borderRadius:1},children:(0,a.Y)(m.A,{variant:"caption",children:P})}):0===r.length?(0,a.Y)(g.A,{sx:{mb:1,p:1,textAlign:"center",borderRadius:1},children:(0,a.Y)(m.A,{variant:"caption",children:"No tweets found"})}):r.map(e=>(0,a.FD)(p.A,{sx:{mb:1,borderRadius:2,transition:"transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out","&:hover":{transform:"translateY(-2px)",boxShadow:3}},children:[(0,a.Y)(S.A,{sx:{p:1},avatar:(0,a.Y)(v.A,{src:e.profile_image_url,alt:e.name,sx:{width:24,height:24},children:e.name.charAt(0)}),title:(0,a.FD)(g.A,{sx:{display:"flex",alignItems:"center"},children:[(0,a.Y)(m.A,{variant:"caption",sx:{fontWeight:"bold",mr:.5},children:e.name}),(0,a.FD)(m.A,{variant:"caption",color:"text.secondary",children:["@",e.username]}),void 0!==e.heat_score&&(0,a.FD)(g.A,{component:"span",sx:{ml:"auto",fontSize:"0.6rem",px:.5,py:.1,borderRadius:1,bgcolor:e.heat_score>80?"error.main":e.heat_score>50?"warning.main":"info.main",color:"white"},children:[e.heat_score,"\xb0"]})]}),subheader:(0,a.Y)(m.A,{variant:"caption",color:"text.secondary",children:(e=>{try{let t=new Date(e),s=new Date().getTime()-t.getTime(),a=Math.floor(s/864e5);if(0===a){let e=Math.floor(s/36e5);if(0===e){let e=Math.floor(s/6e4);return"".concat(e," min").concat(1!==e?"s":""," ago")}return"".concat(e," hour").concat(1!==e?"s":""," ago")}if(1===a)return"Yesterday";if(a<7)return"".concat(a," days ago");else return t.toLocaleDateString()}catch(t){return e}})(e.created_at)})}),(0,a.Y)(y.A,{sx:{py:.5,px:1.5},children:(0,a.Y)(m.A,{variant:"body2",children:e.text})}),e.media&&e.media.length>0&&"photo"===e.media[0].type&&(0,a.Y)(b.A,{component:"img",image:e.media[0].url,alt:"Tweet media",sx:{maxHeight:150,objectFit:"contain"}}),(0,a.FD)(g.A,{sx:{display:"flex",p:.5,pl:1.5},children:[(0,a.FD)(m.A,{variant:"caption",color:"text.secondary",sx:{mr:1},children:["♥ ",e.likes_count]}),(0,a.FD)(m.A,{variant:"caption",color:"text.secondary",children:["↻ ",e.retweets_count]})]})]},e.id))}),(0,a.FD)(w.A,{open:z,onClose:()=>R(!1),maxWidth:"xs",PaperProps:{sx:{maxHeight:"80vh"}},children:[(0,a.Y)(x.A,{children:"X Feed Settings"}),(0,a.FD)(A.A,{children:[(0,a.Y)(m.A,{variant:"subtitle2",sx:{mb:1},children:"Add X accounts to follow"}),(0,a.FD)(g.A,{sx:{display:"flex",mb:2},children:[(0,a.Y)(_.A,{fullWidth:!0,variant:"outlined",size:"small",placeholder:"@username",value:J,onChange:e=>L(e.target.value),sx:{mr:1}}),(0,a.Y)(h.A,{variant:"contained",size:"small",onClick:()=>{if(!J.trim())return;let e=J.trim();if(e.startsWith("@")&&(e=e.substring(1)),e=e.replace(/[^a-zA-Z0-9_]/g,"")){if(X.includes(e))return void L("");i({type:"UPDATE_XFEED",payload:{followedAccounts:[...X,e]}}),L(""),0===X.length&&W()}},disabled:!J,children:"Add"})]}),(0,a.Y)(I.A,{sx:{my:1}}),(0,a.Y)(m.A,{variant:"subtitle2",sx:{mb:1},children:"Followed Accounts"}),0===X.length?(0,a.Y)(m.A,{variant:"body2",color:"text.secondary",children:"No accounts added yet"}):(0,a.Y)(D.A,{dense:!0,disablePadding:!0,children:X.map(e=>(0,a.Y)(N.Ay,{dense:!0,secondaryAction:(0,a.Y)(u.A,{edge:"end",onClick:()=>{i({type:"UPDATE_XFEED",payload:{followedAccounts:X.filter(t=>t!==e)}})},size:"small",children:(0,a.Y)(E.A,{fontSize:"small"})}),children:(0,a.FD)(m.A,{variant:"body2",children:["@",e]})},e))})]}),(0,a.Y)(Y.A,{children:(0,a.Y)(h.A,{onClick:()=>R(!1),size:"small",children:"Close"})})]})]})};function H(){let{user:e,isAuthenticated:t}=(0,i.A)(),s=(0,r.c4)(),[l,d]=(0,o.useState)([]),[g,m]=(0,o.useState)(null),[u,h]=(0,o.useState)([]),[f,p]=(0,o.useState)(""),[S,v]=(0,o.useState)(!1),[y,b]=(0,o.useState)(""),[w,x]=(0,o.useState)(!1),A=(0,o.useRef)(null),{initializeFromPersistedState:_,getSavedDraftMessage:I,updateDraftMessage:D,syncScrollPosition:N,getSavedScrollPosition:Y}=c(g,l,u,f),C=e=>{if(!e)return"New Conversation";try{let t=e.split(".")[0].trim();return(t.length>30?t.substring(0,30)+"...":t)||"New Conversation"}catch(e){return console.error("Error generating topic:",e),"New Conversation"}},T=(e,t)=>{if(e&&t)try{let s=t.slice(-50);localStorage.setItem("messages_".concat(e),JSON.stringify(s)),localStorage.setItem("lastSynced_".concat(e),new Date().toISOString()),localStorage.setItem("activeSessionId",e)}catch(e){console.error("Failed to store messages in localStorage:",e)}},F=e=>{if(!e)return[];try{let t=localStorage.getItem("messages_".concat(e));if(t){let s=JSON.parse(t);if(Array.isArray(s)&&s.length>0)return console.log("Loaded cached messages for session:",e),s}}catch(e){console.error("Failed to load messages from cache:",e)}return[]},E=(0,o.useRef)(!0);(0,o.useEffect)(()=>{!w&&t&&_(d,m)&&(x(!0),console.log("Chat sessions restored from persisted state"))},[w,t,_]),(0,o.useEffect)(()=>{if(g){let e=I();e&&e!==f&&p(e)}},[g,I]),(0,o.useEffect)(()=>{g&&f&&D(f)},[g,f,D]),(0,o.useEffect)(()=>{if(A.current){let e=Y();null!==e?setTimeout(()=>{var t;let s=null==(t=A.current)?void 0:t.parentElement;s&&"number"==typeof e&&!isNaN(e)&&(s.scrollTop=e)},100):A.current.scrollIntoView({behavior:"smooth"})}},[u,g,Y]);let k=(0,o.useCallback)(e=>{g&&N(e.currentTarget.scrollTop)},[g,N]);(0,o.useEffect)(()=>()=>{E.current=!1},[]),(0,o.useEffect)(()=>{(async()=>{if(!t||!s){d([]),m(null),h([]),x(!1);try{JSON.parse(localStorage.getItem("activeSessionIds")||"[]").forEach(e=>{localStorage.removeItem("messages_".concat(e))}),localStorage.removeItem("activeSessionIds"),localStorage.removeItem("activeSessionId")}catch(e){console.error("Error cleaning up localStorage on logout:",e)}return}try{let{data:e,success:t}=await n.FH.get(n.Sn.CHAT.SESSIONS);if(t&&e&&Array.isArray(e)){console.log("Loaded sessions:",e);let t=e.map(e=>{let t=e.topic||e.name;if(!t||"New Chat"===t||"New Conversation"===t)if(e.preview_message)t=C(e.preview_message);else if(e.messages&&Array.isArray(e.messages)&&e.messages.length>0){let s=e.messages[0],a=s.text||s.user||s.message;t=C(a)}else t="Conversation ".concat(new Date(e.lastActivity||e.created||new Date).toLocaleDateString());return{id:e.session_id||e.id,name:t,lastActivity:e.lastActivity||e.last_activity||new Date().toISOString(),messages:[],session_id:e.session_id||e.id,topic:t}}).sort((e,t)=>new Date(t.lastActivity).getTime()-new Date(e.lastActivity).getTime());d(t);let s=localStorage.getItem("activeSessionId"),a=t.some(e=>e.session_id===s||e.id===s);if(s&&a){m(s);try{let e=localStorage.getItem("messages_".concat(s));if(e)try{let t=JSON.parse(e);console.log("Restored ".concat(t.length," messages for session ").concat(s," from localStorage")),h(t),P(!0),localStorage.setItem("activeSessionId",s)}catch(e){console.error("Failed to parse saved messages:",e)}}catch(e){console.error("Failed to access localStorage:",e)}M(s)}else t.length>0?(m(t[0].session_id||t[0].id),M(t[0].session_id||t[0].id)):await z()}else await z()}catch(e){console.error("Failed to load sessions:",e),b("Failed to load chat sessions"),await z()}})()},[t,s]);let[H,P]=(0,o.useState)(!1),M=(0,o.useCallback)(async e=>{if(!e||!t)return;let s=F(e),a=s.length>0;a&&(console.log("Using cached messages while backend loads for session:",e),JSON.stringify(s)!==JSON.stringify(u)&&(h(s),P(!0),localStorage.setItem("activeSessionId",e)));try{if(b(""),!(0,r.c4)())return void console.error("No auth token available");let{data:t,success:o}=await n.FH.get(n.Sn.CHAT.HISTORY(e));if(o&&t&&Array.isArray(t)){let o=t.map(e=>e.user?{sender:"user",text:e.user,timestamp:e.timestamp}:e.bot?{sender:"grace",text:e.bot,timestamp:e.timestamp}:e);if(o.length>0)if(a)if(o.length>s.length)console.log("Backend has more messages than cache, updating"),h(o),T(e,o);else{let t=o.length>0?new Date(o[o.length-1].timestamp).getTime():0,a=s.filter(e=>new Date(e.timestamp||Date.now()).getTime()>t);if(a.length>0){console.log("Merging backend messages with local messages");let t=[...o,...a];h(t),T(e,t)}else JSON.stringify(o)!==JSON.stringify(s)&&(h(o),T(e,o))}else console.log("Setting messages from backend, no cache available"),h(o),T(e,o);else a||h([])}}catch(t){console.error("Failed to load messages for session ".concat(e,":"),t),a||h([])}},[t]);(0,o.useEffect)(()=>{g&&t&&w&&(console.log("Session ID changed, loading messages for:",g),localStorage.setItem("activeSessionId",g),M(g))},[g,M,t,w]),(0,o.useEffect)(()=>{if(!t||!w)return;console.log("Attempting to restore previous session");let e=[...l].sort((e,t)=>new Date(t.lastActivity).getTime()-new Date(e.lastActivity).getTime());d(e);let s=localStorage.getItem("activeSessionId");s&&e.some(e=>(e.session_id||e.id)===s)?(console.log("Found previous session in loaded sessions:",s),m(s)):e.length>0&&(console.log("No saved session found, selecting most recent session"),m(e[0].session_id||e[0].id))},[t,w,l]),(0,o.useEffect)(()=>{A.current&&setTimeout(()=>{var e;null==(e=A.current)||e.scrollIntoView({behavior:"smooth"})},100),g&&u.length>0&&T(g,u)},[u,g]),(0,o.useCallback)(async()=>{if(t)try{let{data:e,success:t}=await n.FH.get(n.Sn.CHAT.SESSIONS);if(t&&Array.isArray(e)){let t=[...e].sort((e,t)=>new Date(t.lastActivity).getTime()-new Date(e.lastActivity).getTime());d(t)}}catch(e){console.error("Failed to refresh sessions:",e)}},[t]);let z=(0,o.useCallback)(async()=>{if(t)try{b("");let{data:e,success:t}=await n.FH.post(n.Sn.CHAT.NEW_SESSION,{});if(t&&e){let t={id:e.session_id,name:e.name||"New Conversation",lastActivity:e.lastActivity||new Date().toISOString(),messages:[],session_id:e.session_id,topic:e.topic||"New Conversation"};return d(e=>[t,...e]),h([]),m(t.session_id),T(t.session_id,[]),localStorage.setItem("activeSessionId",t.session_id),P(!0),t.session_id}throw Error("Failed to create session")}catch(s){console.error("Failed to create new session:",s),b("Failed to create new chat session");let e="session-".concat(Date.now(),"-").concat(Math.random().toString(36).substring(2,9)),t={id:e,name:"New Conversation",lastActivity:new Date().toISOString(),messages:[],session_id:e,topic:"New Conversation"};return d(e=>[t,...e]),h([]),m(e),T(e,[]),localStorage.setItem("activeSessionId",e),P(!0),e}},[t]),R=async()=>{if(!f.trim()||!t||!g)return;let e=[...u,{sender:"user",text:f,timestamp:new Date().toISOString()}];T(g,e),localStorage.setItem("activeSessionId",g),h(e);let s=l.find(e=>e.session_id===g||e.id===g),a=s&&(!s.topic||"New Conversation"===s.topic||s.topic.startsWith("Chat ")||s.topic.startsWith("Conversation "));if(0===u.length&&a&&f)try{let e=C(f),t=l.map(t=>t.session_id===g||t.id===g?{...t,topic:e,name:e}:t);d(t)}catch(e){console.error("Error updating session topic:",e)}p(""),v(!0);try{let{data:t,success:s}=await n.FH.post(n.Sn.CHAT.MESSAGE,{session_id:g,message:f});if(s&&t){let s={sender:"grace",text:t.response||"",timestamp:new Date().toISOString()},a=[...e,s];if(T(g,a),localStorage.setItem("activeSessionId",g),h(a),M(g),t.topic)try{let e=l.map(e=>e.session_id===g||e.id===g?{...e,topic:t.topic,name:t.topic}:e);d(e)}catch(e){console.error("Error updating session with server topic:",e)}}else b("Failed to get response")}catch(t){console.error("Failed to send message:",t),b("Failed to send message"),T(g,e),localStorage.setItem("activeSessionId",g),h(e)}finally{v(!1),setTimeout(()=>{A.current&&A.current.scrollIntoView({behavior:"smooth"})},100)}},[J,L]=(0,o.useState)(!1),X=()=>{L(!J)};return(0,a.FD)("div",{className:"flex h-[calc(100vh-16rem)] overflow-hidden rounded-lg border border-red-700",children:[(0,a.Y)("button",{className:"md:hidden absolute top-2 left-2 z-10 bg-red-800 rounded-full p-2 text-white shadow-md",onClick:X,children:(0,a.Y)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,a.Y)("path",{fillRule:"evenodd",d:"M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z",clipRule:"evenodd"})})}),(0,a.FD)("aside",{className:"".concat(J?"block":"hidden"," md:block absolute md:relative md:w-64 w-3/4 bg-black border-r border-red-800 p-4 overflow-y-auto h-full z-10"),children:[(0,a.FD)("h2",{className:"text-red-300 text-lg font-mono mb-2 flex justify-between items-center",children:[(0,a.Y)("span",{children:"Sessions"}),(0,a.Y)("button",{onClick:X,className:"md:hidden text-red-300 hover:text-red-100",children:(0,a.Y)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,a.Y)("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]}),(0,a.Y)("button",{onClick:()=>{z(),L(!1)},className:"w-full mb-4 rounded bg-red-700 px-4 py-2 hover:bg-red-900",disabled:!t||S,children:"+ New Chat"}),y&&(0,a.Y)("p",{className:"text-red-500 text-xs mb-2",children:y}),!t&&(0,a.Y)("p",{className:"text-yellow-500 text-xs mb-2",children:"Please log in to use chat"}),(0,a.Y)("ul",{className:"space-y-2",children:l.map(e=>{let t=e.session_id||e.id;return t?(0,a.Y)("li",{className:"relative group",children:(0,a.Y)("button",{onClick:()=>{h([]),m(t);let e=F(t);e.length>0&&h(e),localStorage.setItem("activeSessionId",t),L(!1)},className:"w-full text-left px-3 py-2 rounded text-sm hover:bg-red-800 ".concat(g===t?"bg-red-900 text-white":"text-red-300"),children:e.topic||e.name||"Chat ".concat(t.slice(0,6))})},t):null})})]}),J&&(0,a.Y)("div",{className:"md:hidden fixed inset-0 bg-black bg-opacity-50 z-0",onClick:()=>L(!1)}),(0,a.FD)("main",{className:"flex-1 bg-black flex flex-col",children:[(0,a.FD)("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",onScroll:k,children:[0===u.length&&!S&&(0,a.Y)("div",{className:"text-center text-gray-500 my-8",children:t?"No messages yet. Start a conversation!":"Please log in to start chatting"}),S&&(0,a.Y)("div",{className:"text-center text-yellow-500 my-4 animate-pulse",children:"Grace is thinking..."}),u.map((e,t)=>(0,a.FD)("div",{className:"mb-4",children:["user"===e.sender||e.user?(0,a.FD)("div",{className:"text-right p-2 rounded-lg bg-red-900/30 text-red-300",children:[(0,a.Y)("span",{className:"font-bold",children:"You:"})," ",e.text||e.user]}):null,"grace"===e.sender||e.bot?(0,a.FD)("div",{className:"text-left p-2 rounded-lg bg-green-900/30 text-green-300",children:[(0,a.Y)("span",{className:"font-bold",children:"Grace:"})," ",e.text||e.bot]}):null]},t)),(0,a.Y)("div",{ref:A})]}),(0,a.FD)("footer",{className:"flex border-t border-red-800 bg-black p-4",children:[(0,a.Y)("textarea",{className:"flex-1 mr-2 rounded bg-white/10 p-2 text-white min-h-[60px] resize-none",placeholder:t?"Type your message... (Shift+Enter for new line)":"Please log in to chat",value:f,onChange:e=>p(e.target.value),onKeyDown:e=>{"Enter"===e.key&&!e.shiftKey&&(e.preventDefault(),!S&&t&&f.trim()&&R())},disabled:!t||S,autoFocus:!0,"aria-label":"Chat message input",ref:e=>{e&&t&&!S&&setTimeout(()=>e.focus(),100)}}),(0,a.Y)("button",{onClick:R,disabled:S||!t||!f.trim(),className:"rounded bg-red-700 px-4 py-2 hover:bg-red-900 disabled:bg-gray-700 disabled:cursor-not-allowed",children:S?"...":"Send"})]}),(0,a.Y)("div",{className:"border-t border-red-800/50 p-4 bg-black/70",children:(0,a.FD)("div",{className:"bg-transparent text-white p-4",children:[(0,a.FD)("div",{className:"flex justify-between items-center mb-2",children:[(0,a.Y)("h3",{className:"flex items-center text-red-500 font-bold relative pl-4 before:content-[''] before:absolute before:left-0 before:top-0 before:h-full before:w-1 before:bg-red-500",children:"XFeed Channel"}),(0,a.FD)("button",{onClick:()=>{let e=document.querySelector("[data-xfeed-settings]");e&&e instanceof HTMLElement&&e.click()},className:"text-xs px-2 py-1 rounded bg-red-900/50 text-red-200 hover:bg-red-800 flex items-center space-x-1",children:[(0,a.Y)("span",{className:"text-lg leading-none",children:"+"}),(0,a.Y)("span",{children:"Add Account"})]})]}),(0,a.Y)("hr",{className:"border-gray-800 mb-4"}),(0,a.Y)(O,{maxItems:3})," "]})})]})]})}},4480:(e,t,s)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/chat",function(){return s(1652)}])}},e=>{e.O(0,[40,276,636,593,792],()=>e(e.s=4480)),_N_E=e.O()}]);
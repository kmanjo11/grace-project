"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[179],{1179:(e,t,r)=>{r.d(t,{A:()=>m,U:()=>d});var n=r(1933),o=r(8153),i=r(4232),a=r(6874),s=r(4054),l=r(3734);class c{on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}emit(e,t){this.listeners[e]&&this.listeners[e].forEach(e=>e(t))}off(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(e=>e!==t))}clear(e){this.listeners[e]=[]}constructor(){(0,n._)(this,"listeners",{})}}let d=new c,u=e=>{let{position:t,onClose:r}=e,n="leverage"===t.type,a="unrealizedPnl"in t&&t.unrealizedPnl||0,s=t.entryPrice>0?(t.currentPrice-t.entryPrice)/t.entryPrice*100:0,l="openTimestamp"in t?"string"==typeof t.openTimestamp?new Date(t.openTimestamp).getTime():t.openTimestamp:Date.now(),[c,u]=(0,i.useState)(!1),[m,p]=(0,i.useState)(100),[h,g]=(0,i.useState)(!1),f=async()=>{try{g(!0),await r(t.id,m)&&(d.emit("positionClosed",{positionId:t.id,percentage:m}),u(!1),p(100))}catch(e){console.error("Error closing position:",e)}finally{g(!1)}},y=(t.amount*m/100).toFixed(4),x=(t.currentPrice*t.amount*m/100).toFixed(2);return(0,o.FD)("div",{className:"bg-gray-900 rounded-lg p-4 mb-3 border-l-4 border-red-500 border border-gray-700",children:[(0,o.FD)("div",{className:"flex justify-between items-start",children:[(0,o.FD)("div",{children:[(0,o.Y)("h4",{className:"font-medium text-white",children:t.token}),(0,o.FD)("div",{className:"text-sm text-gray-400",children:[t.amount.toFixed(4)," @ $",t.entryPrice.toFixed(2)]}),n&&"leverage"in t&&(0,o.FD)("div",{className:"text-xs text-yellow-400 mt-1",children:["Leverage: ",t.leverage,"x"]}),(0,o.Y)("div",{className:"text-xs text-gray-500 mt-1",children:new Date(l).toLocaleString()})]}),(0,o.FD)("div",{className:"text-right",children:[(0,o.FD)("div",{className:"text-sm font-medium ".concat(a>=0?"text-green-400":"text-red-400"),children:["$",a.toFixed(2)," (",s.toFixed(2),"%)"]}),(0,o.FD)("div",{className:"text-xs text-gray-400",children:["$",(t.amount*t.currentPrice).toFixed(2)]}),(0,o.FD)("div",{className:"text-xs text-gray-500",children:["Current: $",t.currentPrice.toFixed(2)]})]})]}),c?(0,o.FD)("div",{className:"mt-3 border-t border-gray-700 pt-2",children:[(0,o.FD)("div",{className:"flex items-center justify-between mb-2",children:[(0,o.FD)("div",{className:"text-sm text-gray-300",children:["Close: ",(0,o.FD)("span",{className:"font-medium",children:[m,"%"]}),(0,o.FD)("span",{className:"text-xs text-gray-400 ml-1",children:["(",y," ",t.token," â‰ˆ $",x,")"]})]}),(0,o.Y)("button",{onClick:()=>u(!1),className:"text-xs text-gray-400 hover:text-white",children:"Cancel"})]}),(0,o.FD)("div",{className:"mb-3",children:[(0,o.Y)("input",{type:"range",min:"1",max:"100",value:m,onChange:e=>p(parseInt(e.target.value)),className:"w-full"}),(0,o.FD)("div",{className:"flex justify-between text-xs text-gray-500",children:[(0,o.Y)("span",{children:"1%"}),(0,o.Y)("span",{children:"25%"}),(0,o.Y)("span",{children:"50%"}),(0,o.Y)("span",{children:"75%"}),(0,o.Y)("span",{children:"100%"})]})]}),(0,o.Y)("div",{className:"flex justify-end space-x-2",children:(0,o.FD)("button",{onClick:f,disabled:h,className:"text-xs ".concat(h?"bg-gray-600":"bg-red-600 hover:bg-red-700"," text-white px-3 py-1 rounded flex items-center"),children:[h&&(0,o.FD)("svg",{className:"animate-spin -ml-1 mr-2 h-3 w-3 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,o.Y)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,o.Y)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),h?"Processing...":"Confirm Close"]})})]}):(0,o.Y)("div",{className:"mt-3 flex justify-end space-x-2",children:(0,o.Y)("button",{onClick:()=>u(!0),className:"text-xs bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded",children:"Close Position"})})]})},m=e=>{let{initialExpanded:t=!1,onToggleExpand:r,refreshInterval:n=3e4}=e,{user:c}=(0,a.A)(),[m,p]=(0,i.useState)([]),[h,g]=(0,i.useState)([]),[f,y]=(0,i.useState)(t),[x,v]=(0,i.useState)(!0),[b,w]=(0,i.useState)(null),[N,P]=(0,i.useState)(null),k=(0,i.useRef)(!0),F=(0,i.useRef)(),S=(0,i.useRef)(),D=(0,i.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!(null==c?void 0:c.token))return void w("Authentication required");e||v(!0);try{let{data:e,success:t,error:r}=await s.FH.get(s.Sn.WALLET.TRANSACTIONS,{headers:{Authorization:"Bearer ".concat(c.token)}});if(t&&e)g(Array.isArray(e)?e:[]);else throw Error(r||"Failed to fetch transactions")}catch(r){let t=r instanceof Error?r.message:"Failed to fetch transactions";throw console.error("Error fetching transactions:",r),e||(l.oR.error(t),setTimeout(()=>D(!0),5e3)),r}finally{e||v(!1)}},[null==c?void 0:c.token]);(0,i.useCallback)(e=>{try{var t;if(!(e=>"object"==typeof e&&null!==e&&"string"==typeof e.id&&"string"==typeof e.token&&("spot"===e.type||"leverage"===e.type)&&"number"==typeof e.amount&&"number"==typeof e.entryPrice&&"number"==typeof e.currentPrice&&"number"==typeof e.openTimestamp)(e))return void console.warn("Invalid trade data",e);let r=e.entryPrice||0,n=e.currentPrice||r,o=e.amount||0,i={...e,id:e.id||"trade_".concat(Date.now()),token:e.token||"UNKNOWN",type:e.type||"spot",amount:o,entryPrice:r,currentPrice:n,openTimestamp:(null==(t=e.openTimestamp)?void 0:t.toString())||new Date().toISOString(),timestamp:e.timestamp||new Date().toISOString(),currentValue:o*n,profitLoss:r?(n-r)/r*100:0},a={id:i.id,type:"leverage"===i.type?"buy":"swap",token:i.token,amount:i.amount,timestamp:i.openTimestamp,status:"completed"};p(e=>[...e,i]),g(e=>[a,...e]),D().catch(e=>{console.error("Error refreshing transactions:",e)})}catch(e){console.error("Error tracking new trade:",e),l.oR.error("Failed to track new trade")}},[D]);let E=(0,i.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(c){e||(v(!0),w(null));try{let e={positions:[]},t={positions:[]};try{e=await s.S1.getUserSpotPositions(),d.emit("walletPositionsUpdated",{type:"spot",count:e.positions.length,timestamp:new Date().toISOString()})}catch(e){console.error("Error fetching spot positions:",e)}try{t=await s.S1.getUserLeveragePositions(),d.emit("walletPositionsUpdated",{type:"leverage",count:t.positions.length,timestamp:new Date().toISOString()})}catch(e){console.error("Error fetching leverage positions:",e)}if(!k.current)return;let r=e=>{let t={id:e.id,token:e.token,type:e.type,amount:e.amount,entryPrice:e.entryPrice,currentPrice:e.currentPrice||0,currentValue:e.amount*(e.currentPrice||0),profitLoss:e.unrealizedPnl||0,openTimestamp:new Date(e.openTimestamp||Date.now()).toISOString(),side:e.side,market:e.market,timestamp:e.timestamp,unrealizedPnl:e.unrealizedPnl,realizedPnl:e.realizedPnl};return"leverage"===e.type?{...t,leverage:e.leverage||1,liquidationPrice:e.liquidationPrice||0,marginRatio:e.marginRatio||0}:t},n=[...(e.positions||[]).map(r),...(t.positions||[]).map(r)];p(n),P(new Date)}catch(t){throw console.error("Error fetching positions:",t),p([]),e||(w(t instanceof Error?t.message:"Failed to fetch positions"),setTimeout(()=>E(!0),5e3)),t}finally{e||v(!1)}}},[null==c?void 0:c.token]);(0,i.useEffect)(()=>{E()},[c]),(0,i.useEffect)(()=>{let e=e=>{console.log("Trade confirmed, refreshing positions:",e),E().catch(e=>{console.error("Error refreshing positions after trade confirmation:",e)})};return d.on("trade:confirmed",e),()=>{d.off("trade:confirmed",e)}},[E]),(0,i.useEffect)(()=>((async()=>{try{await Promise.all([E().catch(e=>console.log("Positions not available yet: waiting for auth")),D().catch(e=>console.log("Transactions not available yet: waiting for auth"))])}catch(e){console.error("Initial fetch failed:",e)}})(),F.current=setInterval(()=>{E().catch(console.error)},n),S.current=setInterval(()=>{D().catch(console.error)},2*n),()=>{F.current&&clearInterval(F.current),S.current&&clearInterval(S.current)}),[c,n,E,D]),(0,i.useEffect)(()=>()=>{k.current=!1,F.current&&clearInterval(F.current),S.current&&clearInterval(S.current)},[]),(0,i.useCallback)(async e=>{if(!c)return l.oR.error("Authentication required to close positions"),!1;let t=m.find(t=>t.id===e);if(!t)return l.oR.error("Position not found"),!1;if(!window.confirm("Are you sure you want to close this ".concat(t.token," position?")))return!1;try{v(!0);let r=await s.S1.sellPosition({positionId:e,token:t.token,amount:t.amount,type:t.type});if(r.success)return p(t=>t.filter(t=>t.id!==e)),d.emit("positionSold",{...t,timestamp:new Date().toISOString(),wallet_affected:!0,transaction_type:"position_close"}),await Promise.all([E(),D()]),l.oR.success(r.message||"Successfully closed ".concat(t.token," position")),!0;throw Error(r.error||"Failed to close position")}catch(e){return console.error("Error selling position",e),l.oR.error(e instanceof Error?e.message:"Failed to close position"),!1}},[null==c?void 0:c.token,m,v,E,D,d]),(0,i.useMemo)(()=>{let e=m.reduce((e,t)=>e+t.currentValue,0),t=m.reduce((e,t)=>e+t.profitLoss,0),r=m.filter(e=>e.profitLoss>0).length;return{totalValue:e,totalPnl:t,winRate:m.length>0?r/m.length*100:0,totalPositions:m.length,lastUpdated:N}},[m,N]);let Y=(0,i.useCallback)(async(e,t)=>{if(!(null==c?void 0:c.token))return l.oR.error("Authentication required to close positions"),!1;let r=m.find(t=>t.id===e);if(!r)return l.oR.error("Position not found"),!1;let n=t&&t>0&&t<100,o=n?r.amount*t/100:r.amount;try{v(!0);let i=await s.S1.sellPosition({positionId:e,token:r.token,amount:r.amount,type:r.type,percentage:t});if(i.success){n?p(t=>t.map(t=>t.id===e?{...t,amount:t.amount-o}:t)):p(t=>t.filter(t=>t.id!==e)),d.emit("positionSold",{...r,amount:o,percentage:t||100,isPartial:n,timestamp:new Date().toISOString()}),await Promise.all([E(),D()]);let a=n?"Successfully closed ".concat(t,"% of ").concat(r.token," position"):"Successfully closed ".concat(r.token," position");return l.oR.success(i.message||a),!0}throw Error(i.error||"Failed to close position")}catch(t){let e=t instanceof Error?t.message:"Failed to close position";return console.error("Error closing position:",t),l.oR.error("Error: ".concat(e)),!1}finally{v(!1)}},[null==c?void 0:c.token,m,E,D]);return(0,o.FD)("div",{className:"bg-gray-800 shadow-md rounded-lg p-4 border border-gray-700",children:[(0,o.FD)("div",{className:"flex justify-between items-center mb-4",children:[(0,o.Y)("h2",{className:"text-lg font-semibold text-red-300",children:"Public Trading Positions"}),(0,o.Y)("button",{onClick:()=>{y(!f)},className:"text-red-400 hover:text-red-300 text-sm bg-red-900/30 px-2 py-1 rounded border border-red-800",children:f?"Collapse":"Expand"})]}),c?x?(0,o.FD)("div",{className:"text-center py-4 border border-gray-700 rounded bg-gray-900/50 p-4",children:[(0,o.Y)("p",{className:"text-gray-300 mb-2",children:"Loading positions..."}),(0,o.Y)("div",{className:"flex justify-center mt-2",children:(0,o.Y)("div",{className:"animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-red-500"})})]}):0===m.length?(0,o.FD)("div",{className:"text-center py-4 border border-gray-700 rounded bg-gray-900/50 p-4",children:[(0,o.Y)("p",{className:"text-gray-300 mb-2",children:"No trading positions available"}),(0,o.Y)("p",{className:"text-sm text-gray-400",children:"Your active trades will appear here"})]}):(0,o.Y)("div",{className:"overflow-hidden",children:m.map(e=>(0,o.Y)(u,{position:e,onClose:Y},e.id))}):(0,o.FD)("div",{className:"text-center py-4 border border-gray-700 rounded bg-gray-900/50 p-4",children:[(0,o.Y)("p",{className:"text-gray-300 mb-2",children:"Trading Widget"}),(0,o.Y)("p",{className:"text-sm text-gray-400",children:"Log in to view your trading positions"})]})]})}}}]);